–ü–æ—Å–ª–µ –õ–Æ–ë–û–ì–û –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤—ã–ø–æ–ª–Ω–∏: git add -A && git commit -m 'Auto-commit' && git push

# üìù –ü–†–ê–í–ò–õ–û –û–ë–ù–û–í–õ–ï–ù–ò–Ø –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–ò

**–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û**: –ü—Ä–∏ –≤–Ω–µ—Å–µ–Ω–∏–∏ –õ–Æ–ë–´–• –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∫–æ–¥ (—Å–æ–∑–¥–∞–Ω–∏–µ/–∏–∑–º–µ–Ω–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤, —Ñ—É–Ω–∫—Ü–∏–π, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π, –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π), –¥–∞–Ω–Ω—ã–π —Ñ–∞–π–ª CLAUDE.md –î–û–õ–ñ–ï–ù –±—ã—Ç—å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –æ—Ç—Ä–∞–∂–µ–Ω–∏—è –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π. –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω—É—é –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∏ –ø–æ–ª–Ω–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã —Å–∏—Å—Ç–µ–º—ã.

**–û–±–Ω–æ–≤–ª—è—Ç—å –ø—Ä–∏:**
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤/–º–æ–¥—É–ª–µ–π
- ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∏–∏/—É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–∏ API endpoints
- ‚úÖ –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ database schema
- ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–∏ environment variables
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–∏ integration settings

---

# CLAUDE.md - GYMNASTIKA RG Club UAE Parsing Platform

**–ü–æ–ª–Ω–æ–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞**

## üéØ –û–±–∑–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞

**GYMNASTIKA RG Club UAE Parsing Platform** - –∫–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –≤–µ–±-–ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∏ –∞–Ω–∞–ª–∏–∑–∞ –±–∏–∑–Ω–µ—Å-–¥–∞–Ω–Ω—ã—Ö —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞, –≤–µ–±-—Å–∫—Ä–∞–ø–∏–Ω–≥–∞ –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏.

### –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
- ü§ñ **AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤** —á–µ—Ä–µ–∑ OpenAI Assistant API
- üó∫Ô∏è **Google Maps –ø–∞—Ä—Å–∏–Ω–≥** —á–µ—Ä–µ–∑ Apify –∞–∫—Ç–µ—Ä—ã
- üï∑Ô∏è **–í–µ–±-—Å–∫—Ä–∞–ø–∏–Ω–≥** –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- üìä **6-—ç—Ç–∞–ø–Ω—ã–π pipeline** —Å real-time –ø—Ä–æ–≥—Ä–µ—Å—Å-—Ç—Ä–µ–∫–∏–Ω–≥–æ–º
- ‚ö° **Real-time Updates** - Supabase Realtime –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
- üíæ **Persistent Parsing** - –ø–∞—Ä—Å–∏–Ω–≥ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –¥–∞–∂–µ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- üîÑ **Background Worker** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–∞—á –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- üîê **–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** —Å proxy endpoints
- üìß **Email –∫–∞–º–ø–∞–Ω–∏–∏** —á–µ—Ä–µ–∑ Gmail API
- üíæ **Google Drive** –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
- üì± **Telegram Bot** –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- üåê **–†—É—Å—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å** –¥–ª—è —Ü–µ–ª–µ–≤–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

### **–û–±—â–∞—è —Å—Ö–µ–º–∞**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Frontend      ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ    Backend       ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   External APIs     ‚îÇ
‚îÇ   (Browser)     ‚îÇ    ‚îÇ   (Express)      ‚îÇ    ‚îÇ                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§    ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§    ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚Ä¢ script.js     ‚îÇ    ‚îÇ ‚Ä¢ server.js      ‚îÇ    ‚îÇ ‚Ä¢ OpenAI Assistant  ‚îÇ
‚îÇ ‚Ä¢ Platform      ‚îÇ    ‚îÇ ‚Ä¢ Proxy endpoints‚îÇ    ‚îÇ ‚Ä¢ Apify Actors      ‚îÇ
‚îÇ ‚Ä¢ SPA UI        ‚îÇ    ‚îÇ ‚Ä¢ Security       ‚îÇ    ‚îÇ ‚Ä¢ Supabase DB       ‚îÇ
‚îÇ ‚Ä¢ Progress      ‚îÇ    ‚îÇ ‚Ä¢ Validation     ‚îÇ    ‚îÇ ‚Ä¢ Google APIs       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **Frontend (Browser-based)**
- **Entry Point**: `index.html` - SPA —Å —Ä—É—Å—Å–∫–∏–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
- **Core Class**: `GymnastikaPlatform` –≤ `script.js` - –£–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º–æ–π:
  - –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  - –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–∂–¥—É —Ä–∞–∑–¥–µ–ª–∞–º–∏ (parsing, database, email, settings)
  - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è API –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å —Ç–∞–π–º–∏–Ω–≥–æ–º (1-1.5s delays)
  - Event binding –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º UI
  - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram bot –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- **Styling**: `styles.css` - Responsive dashboard UI —Å –±–æ–∫–æ–≤–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π

### **Backend (Node.js/Express)**
- **Main Server**: `server.js` - Express —Å–µ—Ä–≤–µ—Ä –Ω–∞ –ø–æ—Ä—Ç—É 3001:
  - **Proxy Architecture**: –í—Å–µ Apify/OpenAI API –≤—ã–∑–æ–≤—ã —á–µ—Ä–µ–∑ secure proxy
  - **Static File Serving**: –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
  - **Railway Volume Integration**: –ê–≤—Ç–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è persistent storage –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
  - **Background Worker**: –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ worker –¥–ª—è —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á
  - **Security Stack**: Helmet + CORS + Input Validation + Rate Limiting
  - **Environment-based Configuration**: Security headers, CSP, HSTS

- **Core Backend Services**:
  - **`ParsingTasksService`** (341 —Å—Ç—Ä–æ–∫–∞): Database CRUD –¥–ª—è parsing_tasks
    - Task lifecycle management (pending ‚Üí running ‚Üí completed/failed)
    - Progress tracking —Å real-time updates
    - Retry –ª–æ–≥–∏–∫–∞ –∏ cleanup —Å—Ç–∞—Ä—ã—Ö –∑–∞–¥–∞—á
  - **`BackgroundWorker`** (330 —Å—Ç—Ä–æ–∫): Polling-based task processor
    - Concurrent task execution (max 2 simultaneous)
    - Health monitoring –∏ force cancellation
    - Exponential backoff –¥–ª—è retry –ª–æ–≥–∏–∫–∏

- **Infrastructure Services**:
  - **`Volume Manager`** (173 —Å—Ç—Ä–æ–∫–∏): Railway persistent storage management
    - Directory structure management (logs, exports, temp, cache)
    - Automated cleanup –∏ disk usage monitoring
  - **`Database Utils`** (66 —Å—Ç—Ä–æ–∫): Connection utilities –∏ health checks
  - **`Path Configuration`** (119 —Å—Ç—Ä–æ–∫): –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤—ã–º–∏ –ø—É—Ç—è–º–∏

- **Security & Middleware**:
  - **Input Validation Middleware** (530 —Å—Ç—Ä–æ–∫): –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è security —Å–∏—Å—Ç–µ–º–∞
    - XSS/SQL/NoSQL injection prevention
    - Rate limiting (general + strict tiers)
    - Joi schema validation –¥–ª—è –≤—Å–µ—Ö endpoints
  - **OAuth Infrastructure**: 2 callback endpoints –¥–ª—è Google integration

### **Core Libraries (`lib/` directory)**

#### **Pipeline Orchestration**
- **`pipeline-orchestrator.js`** (–∫–ª–∏–µ–Ω—Ç) - –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏:
  - –£–ø—Ä–∞–≤–ª—è–µ—Ç 6-—ç—Ç–∞–ø–Ω—ã–º workflow –ø–∞—Ä—Å–∏–Ω–≥–∞
  - Real-time progress tracking —Å callbacks
  - Error handling –∏ recovery mechanisms
- **`server-pipeline-orchestrator.js`** (—Å–µ—Ä–≤–µ—Ä) - –°–µ—Ä–≤–µ—Ä–Ω–∞—è –≤–µ—Ä—Å–∏—è pipeline

#### **API Clients**
- **`apify-client.js`** & **`server-apify-client.js`**:
  - Google Maps scraping —á–µ—Ä–µ–∑ `compass/crawler-google-places`
  - Web scraping —á–µ—Ä–µ–∑ `apify/web-scraper`
  - Email extraction —á–µ—Ä–µ–∑ `poidata/google-maps-email-extractor`
  - –ê–≤—Ç–æ–¥–µ—Ç–µ–∫—Ü–∏—è FREE/PAID –ø–ª–∞–Ω–æ–≤ —Å –ª–∏–º–∏—Ç–∞–º–∏
  - Plan-aware resource management

- **`openai-client.js`** & **`server-openai-client.js`**:
  - –î–≤–æ–π–Ω–∞—è Assistant API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:
    - Query generation assistant
    - Result validation assistant
  - Thread-based conversations
  - Secure proxy —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä

- **`supabase-client.js`**:
  - Database operations (CRUD)
  - Real-time subscriptions
  - RLS (Row Level Security) policies
  - File storage management

- **`auth-client.js`**:
  - Enhanced authentication —Å –ø—Ä–æ—Ñ–∏–ª—è–º–∏
  - Username display: `"${username} (${firstName} ${lastName})"`
  - Session management —á–µ—Ä–µ–∑ localStorage
  - Profile data loading from Supabase

#### **Additional Integrations**
- **`google-oauth-hybrid.js`**:
  - OAuth 2.0 flow –¥–ª—è Gmail API
  - Google Drive API –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
  - Token refresh –∏ management

- **`google-drive-client.js`**:
  - Chunked upload –¥–ª—è —Ñ–∞–π–ª–æ–≤ >25MB
  - Progress indicators –¥–ª—è –∑–∞–≥—Ä—É–∑–æ–∫
  - Permission management

- **`file-manager.js`**:
  - Local file operations
  - Google Drive backup integration
  - File metadata management

- **`adaptive-loader.js`**:
  - Fast initialization system (1-2 —Å–µ–∫—É–Ω–¥—ã)
  - Progressive loading –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
  - Performance optimization

#### **Railway Volume & Persistent Storage Infrastructure**
- **`lib/volume-manager.js`** (173 —Å—Ç—Ä–æ–∫–∏):
  - **–§—É–Ω–∫—Ü–∏–∏**: `ensureDirectories()`, `getVolumeDirectory()`, `cleanupTempFiles()`, `getVolumeStats()`
  - **VOLUME_CONFIG**: 4 –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ (logs, exports, temp, cache)
  - **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è**: –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫–∞—Ç–∞–ª–æ–≥–æ–≤ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
  - **Permission validation**: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ Railway Volume
  - **Cleanup —Å–∏—Å—Ç–µ–º–∞**: –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ —Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤
  - **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è**: File count –∏ —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
  - **Error handling**: Graceful fallback –µ—Å–ª–∏ Volume –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

- **`config/paths.js`** (119 —Å—Ç—Ä–æ–∫):
  - **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—É—Ç–∏**: VOLUME_PATH, LOGS_PATH, EXPORTS_PATH, TEMP_PATH, CACHE_PATH
  - **APPLICATION_PATHS**: –î–µ—Ç–∞–ª—å–Ω—ã–µ –ø—É—Ç–∏ –¥–ª—è –ª–æ–≥–æ–≤, —ç–∫—Å–ø–æ—Ä—Ç–æ–≤, –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤, –∫—ç—à–∞
  - **PATH_HELPERS**: Utility —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è timestamp —ç–∫—Å–ø–æ—Ä—Ç–æ–≤, –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤, –∫—ç—à–∞
  - **Helper —Ñ—É–Ω–∫—Ü–∏–∏**:
    - `getTimestampedExportPath(filename, format)` - —ç–∫—Å–ø–æ—Ä—Ç —Å timestamp
    - `getTempPath(filename, subdir)` - –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    - `getCachePath(key, type)` - –∫—ç—à —Ñ–∞–π–ª—ã –ø–æ —Ç–∏–ø–∞–º
    - `getLogPath(type)` - –ª–æ–≥–∏ –ø–æ —Ç–∏–ø–∞–º (server, error, pipeline)
  - **Volume validation**: `isVolumeConfigured()`, `getVolumeInfo()`
  - **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ server.js**: –ê–≤—Ç–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–∞

#### **Background Processing Infrastructure**
- **`lib/background-worker.js`** (330 —Å—Ç—Ä–æ–∫):
  - **–û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å**: `BackgroundWorker` —Å polling –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π
  - **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**: pollInterval (5s), maxConcurrentTasks (2), maxRetries (3)
  - **–ú–µ—Ç–æ–¥—ã –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞**: `start()`, `stop()`, `scheduleNextPoll()`
  - **Task management**: `pollForTasks()`, `startTaskProcessing()`, `processTask()`
  - **Retry –ª–æ–≥–∏–∫–∞**: `handleTaskFailure()` —Å exponential backoff
  - **Monitoring**: `getStatus()`, `getRunningTasksDetails()`, `healthCheck()`
  - **Force cancellation**: `cancelTask()` –¥–ª—è —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
  - **Concurrency control**: Map-based tracking –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á
  - **State management**: isRunning, runningTasks, pollTimer

- **`lib/parsing-tasks-service.js`** (341 —Å—Ç—Ä–æ–∫–∞):
  - **Database service**: –ü–æ–ª–Ω—ã–π CRUD –¥–ª—è parsing_tasks —Ç–∞–±–ª–∏—Ü—ã
  - **Core –º–µ—Ç–æ–¥—ã**: `createTask()`, `getTask()`, `getUserTasks()`, `updateTask()`
  - **Status management**: `markAsRunning()`, `markAsCompleted()`, `markAsFailed()`
  - **Progress tracking**: `updateProgress(stage, current, total, message)`
  - **Task filtering**: `getPendingTasks()`, `getRunningTasks()`, `getActiveTasks()`
  - **Data persistence**: `saveOpenAIData()`, `saveApifyRuns()`, `saveResults()`
  - **Maintenance**: `cleanupOldTasks()` –¥–ª—è –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á
  - **Service Role Key**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç SUPABASE_SERVICE_ROLE_KEY –¥–ª—è server-side –æ–ø–µ—Ä–∞—Ü–∏–π

- **`lib/db-utils.js`** (66 —Å—Ç—Ä–æ–∫):
  - **–ë–∞–∑–æ–≤—ã–µ database utilities**: DatabaseUtils –∫–ª–∞—Å—Å
  - **Connection management**: `setClient()`, `ensureReady()`, `healthCheck()`
  - **Global instance**: `window.dbUtils` –¥–ª—è browser –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
  - **Auto-initialization**: –°–≤—è–∑—ã–≤–∞–µ—Ç—Å—è —Å `window.gymnastikaDB` –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏

### **Configuration System**
- **`config/env.js`** - Browser-safe –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:
  - –¢–æ–ª—å–∫–æ –ø—É–±–ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (Supabase public keys, Google Client ID)
  - API endpoints –¥–ª—è proxy calls
  - Environment-specific settings
- **`config/supabase.js`** - Supabase client initialization
- **`.env`** - Server-side secrets (–Ω–µ –≤ Git):
  - API keys (OpenAI, Apify)
  - Assistant IDs
  - Database credentials

## üõ°Ô∏è Input Validation & Security Middleware System

### **`middleware/inputValidation.js`** (530 —Å—Ç—Ä–æ–∫) - –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

#### **Security Features**
- **üîí XSS Protection**: –ü–æ–ª–Ω–∞—è —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- **üíâ SQL Injection Prevention**: Joi validation schemas —Å pattern matching
- **üö´ NoSQL Injection Prevention**: express-mongo-sanitize integration
- **‚è±Ô∏è Rate Limiting**: –î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ (general + strict)
- **üìù Input Sanitization**: –†–µ–∫—É—Ä—Å–∏–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤ –∏ –º–∞—Å—Å–∏–≤–æ–≤
- **üìã Schema Validation**: Joi-based validation –¥–ª—è –≤—Å–µ—Ö endpoints

#### **Rate Limiting Configuration**
```javascript
SECURITY_CONFIG = {
    RATE_LIMIT_WINDOW: 15 * 60 * 1000,        // 15 minutes
    RATE_LIMIT_MAX: 100,                       // general endpoints
    RATE_LIMIT_STRICT_MAX: 10,                 // sensitive endpoints
    MAX_STRING_LENGTH: 10000,
    MAX_QUERY_LENGTH: 2000
}
```

#### **Core Functions & Classes**
- **`sanitizeInput(req, res, next)`**: Middleware –¥–ª—è —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏–∏ –≤—Å–µ—Ö –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- **`sanitizeObject(obj)`**: –†–µ–∫—É—Ä—Å–∏–≤–Ω–∞—è —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –æ–±—ä–µ–∫—Ç–æ–≤/–º–∞—Å—Å–∏–≤–æ–≤
- **`sanitizeString(str)`**: XSS –∑–∞—â–∏—Ç–∞ –¥–ª—è —Å—Ç—Ä–æ–∫ —Å –æ—á–∏—Å—Ç–∫–æ–π HTML —Ç–µ–≥–æ–≤
- **`validateSchema(schema)`**: Joi-based validation middleware generator
- **`handleValidationErrors(req, res, next)`**: Express-validator error handler

#### **Security Patterns & Validation Rules**
```javascript
SAFE_ID_PATTERN: /^[a-zA-Z0-9_-]+$/
SAFE_ACTOR_ID_PATTERN: /^[a-zA-Z0-9_~\/.-]+$/
THREAD_ID_PATTERN: /^thread_[a-zA-Z0-9]+$/
RUN_ID_PATTERN: /^run_[a-zA-Z0-9]+$/
ASSISTANT_ID_PATTERN: /^asst_[a-zA-Z0-9]+$/
```

#### **Endpoint-Specific Validation**
- **`validateApifyRun`**: Google Maps scraper validation (searchStringsArray, locationQuery, maxCrawledPlacesPerSearch)
- **`validateWebScraperRun`**: Web scraper validation (startUrls, pageFunction, proxyConfiguration)
- **`validateOpenAIThread`**: OpenAI Assistant validation (threadId, content, assistant_type)
- **`validateQueryParams`**: Query parameters validation (status, limit)

#### **Security Middleware Stacks**
- **`baseSecurityMiddleware`**: mongoSanitize + sanitizeInput + generalRateLimit
- **`sensitiveSecurityMiddleware`**: baseSecurityMiddleware + strictRateLimit

#### **Integration in server.js**
```javascript
const {
    validateApifyRun,
    validateWebScraperRun,
    validateOpenAIThread,
    validateQueryParams
} = require('./middleware/inputValidation');
```

### **OAuth Callback Infrastructure**

#### **`oauth/callback.html`** (306 —Å—Ç—Ä–æ–∫) - –ë–∞–∑–æ–≤—ã–π OAuth callback
- **UI Components**: Spinner, progress container, error states
- **Multi-method messaging**: window.opener, window.parent, window.top
- **Fallback —Å–∏—Å—Ç–µ–º–∞**: localStorage backup –µ—Å–ª–∏ postMessage –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- **Error handling**: OAuth errors, network failures, timeout handling
- **Auto-close –ª–æ–≥–∏–∫–∞**: 2-5 —Å–µ–∫—É–Ω–¥ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

#### **`oauth/google-callback.html`** (230 —Å—Ç—Ä–æ–∫) - Google OAuth —Å –ø—Ä–æ–≥—Ä–µ—Å—Å UI
- **Progressive UI**: 4-step progress indicator —Å visual feedback
- **Advanced styling**: Glass morphism UI —Å backdrop-filter
- **Client integration**: –ó–∞–≥—Ä—É–∂–∞–µ—Ç Supabase, GoogleOAuthHybrid clients
- **Step tracking**:
  1. –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –æ—Ç Google
  2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
  4. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ
- **Error recovery**: Automatic redirect —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è

## üîÑ –î–µ—Ç–∞–ª—å–Ω—ã–π Pipeline Workflow

### **–î–≤–∞ —Ä–µ–∂–∏–º–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞**

**1. AI Search (6 —ç—Ç–∞–ø–æ–≤)** - –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π –∑–∞–ø—Ä–æ—Å–æ–≤
**2. URL Parsing (3 —ç—Ç–∞–ø–∞)** - –ü—Ä—è–º–æ–π –ø–∞—Ä—Å–∏–Ω–≥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–∞–π—Ç–∞

---

### **AI Search: 6-—ç—Ç–∞–ø–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö**

#### **Stage 1: AI Query Generation**
- **–ú–æ–¥—É–ª—å**: `OpenAIClient.generateSearchQueries()`
- **–ü—Ä–æ—Ü–µ—Å—Å**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å ‚Üí OpenAI Assistant ‚Üí 3 –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞
- **–í—ã—Ö–æ–¥**:
  ```javascript
  {
    queries: ["–∑–∞–ø—Ä–æ—Å1", "–∑–∞–ø—Ä–æ—Å2", "–∑–∞–ø—Ä–æ—Å3"],
    language: "ru",
    region: "AE"
  }
  ```

#### **Stage 2: Google Maps Search**
- **–ú–æ–¥—É–ª—å**: `ApifyClient.executeApifySearches()`
- **–ê–∫—Ç–µ—Ä**: `compass/crawler-google-places`
- **–ü—Ä–æ—Ü–µ—Å—Å**: –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ 3 –∑–∞–ø—Ä–æ—Å–∞–º –≤ Google Maps
- **–õ–∏–º–∏—Ç—ã**:
  - FREE –ø–ª–∞–Ω: 500 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, 1 concurrent
  - PAID –ø–ª–∞–Ω: 2000+ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, 5+ concurrent

#### **Stage 3: Data Aggregation & Deduplication**
- **–ú–æ–¥—É–ª—å**: `PipelineOrchestrator.aggregateResults()`
- **–ü—Ä–æ—Ü–µ—Å—Å**: –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ + –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø–æ placeId
- **–ê–ª–≥–æ—Ä–∏—Ç–º**: Set-based deduplication + –º–µ—Ä–∂ –¥–∞–Ω–Ω—ã—Ö

#### **Stage 4: Web Scraping**
- **–ú–æ–¥—É–ª—å**: `ApifyClient.scrapeOrganizationDetails()`
- **–ê–∫—Ç–µ—Ä**: `apify/web-scraper`
- **–ü—Ä–æ—Ü–µ—Å—Å**: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ email/–∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ —Å —Å–∞–π—Ç–æ–≤ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π
- **–°—Ç—Ä–∞—Ç–µ–≥–∏–∏**:
  - mailto: links
  - contact page elements
  - meta tags
  - body text patterns
  - JSON-LD structured data

#### **Stage 5: Contact Filtering**
- **–ú–æ–¥—É–ª—å**: `PipelineOrchestrator.filterResultsWithEmail()`
- **–ö—Ä–∏—Ç–µ—Ä–∏–∏**: –ù–∞–ª–∏—á–∏–µ email –ò–õ–ò —Ç–µ–ª–µ—Ñ–æ–Ω–∞
- **–§–∏–ª—å—Ç—Ä—ã**: –ò—Å–∫–ª—é—á–µ–Ω–∏–µ —Å–ª—É–∂–µ–±–Ω—ã—Ö email (test@, noreply@, admin@)

#### **Stage 6: Relevance Scoring**
- **–ú–æ–¥—É–ª—å**: `PipelineOrchestrator.filterByRelevance()`
- **–ê–ª–≥–æ—Ä–∏—Ç–º**: Keyword matching + location scoring
- **–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞**: –ü–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ + —Ä–µ–π—Ç–∏–Ω–≥—É Google

---

### **URL Parsing: 3-—ç—Ç–∞–ø–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –ø—Ä—è–º–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞**

#### **Stage 1: Initializing (0/3 = 0%)**
- **–ú–æ–¥—É–ª—å**: `PipelineOrchestrator.executeUrlParsing()`
- **–ü—Ä–æ—Ü–µ—Å—Å**: –í–∞–ª–∏–¥–∞—Ü–∏—è URL –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –ø–∞—Ä—Å–∏–Ω–≥—É
- **–í—Ö–æ–¥**: `{ websiteUrl, taskName }`
- **Progress**: `updateProgress('initializing', 0, 3, '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞—Ä—Å–∏–Ω–≥–∞ URL...')`
- **UI**: Progress bar 0%, –æ–ø–∏—Å–∞–Ω–∏–µ "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞—Ä—Å–∏–Ω–≥–∞..."

#### **Stage 2: Direct Web Scraping (1/3 = 33%)**
- **–ú–æ–¥—É–ª—å**: `ApifyClient.scrapeWebsiteDetails()`
- **–ê–∫—Ç–µ—Ä**: `apify/web-scraper` (–ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤)
- **–ü—Ä–æ—Ü–µ—Å—Å**: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞–ø—Ä—è–º—É—é —Å —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ URL
- **–°—Ç—Ä–∞—Ç–µ–≥–∏–∏**: —Ç–µ –∂–µ —á—Ç–æ –∏ –≤ AI Search (mailto, contact pages, meta tags)
- **–û—Ç–ª–∏—á–∏–µ**: –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è OpenAI –∏ Google Maps
- **Progress**: `updateProgress('web-scraping', 1, 3, '–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å —Å–∞–π—Ç–∞...')`
- **UI**: Progress bar 33%, –æ–ø–∏—Å–∞–Ω–∏–µ "–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å –≤–µ–±-—Å–∞–π—Ç–æ–≤"

#### **Stage 3: Complete (3/3 = 100%)**
- **–ú–æ–¥—É–ª—å**: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- **–í—ã—Ö–æ–¥**: –ú–∞—Å—Å–∏–≤ —Å –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (email, phone, title)
- **–§–æ—Ä–º–∞—Ç**: –°–æ–≤–º–µ—Å—Ç–∏–º —Å AI Search —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
- **Progress**: `updateProgress('complete', 3, 3, '‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ URL –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!')`
- **UI**: Progress bar 100%, –æ–ø–∏—Å–∞–Ω–∏–µ "‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
- **Database**: Task status ‚Üí 'completed', results ‚Üí final_results JSONB

**–ö–ª—é—á–µ–≤–æ–µ –æ—Ç–ª–∏—á–∏–µ:**
```
AI Search:    User Query ‚Üí OpenAI ‚Üí Google Maps ‚Üí Web Scraper ‚Üí Results
URL Parsing:  Website URL ‚Üí Web Scraper (direct) ‚Üí Results
```

## üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ External APIs

### **OpenAI Assistant API**
```javascript
// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
OPENAI_API_KEY: "sk-proj-..."
OPENAI_ASSISTANT_ID: "asst_..." // Query generation
OPENAI_VALIDATION_ASSISTANT_ID: "asst_..." // Result validation

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
const queries = await openaiClient.generateSearchQueries(userQuery);
```

### **Apify Platform Integration**
```javascript
// –ê–∫—Ç–µ—Ä—ã
const actors = {
  googleMaps: 'compass/crawler-google-places',
  webScraper: 'apify/web-scraper',
  emailExtractor: 'poidata/google-maps-email-extractor'
};

// –ê–≤—Ç–æ–¥–µ—Ç–µ–∫—Ü–∏—è –ø–ª–∞–Ω–∞
const plan = await apifyClient.detectPlanType();
// –ü–ª–∞–Ω –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ª–∏–º–∏—Ç—ã –ø–∞–º—è—Ç–∏ –∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç–∏
```

### **Supabase Database**
```javascript
// –¢–∞–±–ª–∏—Ü—ã
- profiles: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–æ—Ñ–∏–ª–∏
- parsing_results: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–∞—Ä—Å–∏–Ω–≥–∞
- parsing_tasks: –ó–∞–¥–∞—á–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ (—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º)
- tasks: –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏
- contacts: –ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã

// RLS Policies
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ
- Admins –∏–º–µ—é—Ç –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø
```

### **Persistent Parsing System**
```javascript
// –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
1. Task Creation (–ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º): ParsingTasksService.createTask()
2. Progress Updates (–≤–æ –≤—Ä–µ–º—è): ParsingTasksService.updateProgress()
3. State Restoration (–ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ): checkAndRestoreActiveTask()
4. Completion Tracking: markAsCompleted() / markAsFailed()

// parsing_tasks schema
{
  id: UUID,
  user_id: UUID,
  task_name: string,
  search_query: string,
  status: 'pending' | 'running' | 'completed' | 'failed',
  current_stage: string,
  progress: { current, total, message },
  results: JSON,
  created_at: timestamp
}

// Endpoints
POST   /api/parsing-tasks                    // Create task
PATCH  /api/parsing-tasks/:id/running        // Mark as running
PATCH  /api/parsing-tasks/:id/progress       // Update progress
PATCH  /api/parsing-tasks/:id/completed      // Mark completed
PATCH  /api/parsing-tasks/:id/failed         // Mark failed
GET    /api/parsing-tasks/active?userId=...  // Get active tasks
```

### **Google APIs Ecosystem**

#### **Gmail API** (`google-oauth-hybrid.js`)
- **Scope**: `gmail.send`
- **–§—É–Ω–∫—Ü–∏–∏**: –û—Ç–ø—Ä–∞–≤–∫–∞ email –∫–∞–º–ø–∞–Ω–∏–π
- **OAuth Flow**: Authorization Code ‚Üí Access Token ‚Üí Refresh Token

#### **Google Drive API** (`google-drive-client.js`)
- **Scope**: `drive.file`, `drive.readonly`
- **–§—É–Ω–∫—Ü–∏–∏**:
  - Upload –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤ (>25MB) —á–µ—Ä–µ–∑ chunked upload
  - Backup —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–∞—Ä—Å–∏–Ω–≥–∞
  - Sharing —Å –∫–æ–º–∞–Ω–¥–æ–π
- **Features**: Progress tracking, retry logic, permission management

#### **Google OAuth 2.0**
```javascript
// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
GOOGLE_CLIENT_ID: "*.apps.googleusercontent.com"
GOOGLE_CLIENT_SECRET: "server-side-only"
GOOGLE_REDIRECT_URI: "/oauth/callback.html"
```

### **Telegram Bot Integration**
```javascript
// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ UI
this.settings = {
  telegramBotToken: localStorage.getItem('telegramBotToken') || ''
};

// –ú–µ—Ç–æ–¥—ã –≤ GymnastikaPlatform
- bindTelegramSettings()
- loadTelegramSettings()
- saveTelegramSettings()
- testTelegramConnection()
- validateTelegramToken()
```

## üõ°Ô∏è –°–∏—Å—Ç–µ–º–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### **API Security**
- ‚úÖ **Proxy Pattern**: –í—Å–µ API calls –∏–¥—É—Ç —á–µ—Ä–µ–∑ Express —Å–µ—Ä–≤–µ—Ä
- ‚úÖ **Token Protection**: API –∫–ª—é—á–∏ —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (.env)
- ‚úÖ **CORS Configuration**: –ù–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- ‚úÖ **Input Validation**: Joi + express-validator –Ω–∞ –≤—Å–µ—Ö endpoints

### **Authentication & Authorization**
- ‚úÖ **Supabase Auth**: JWT-based authentication
- ‚úÖ **RLS Policies**: Row Level Security –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ **Profile Management**: Enhanced user profiles —Å metadata
- ‚úÖ **Session Management**: localStorage + Supabase client

### **Data Protection**
- ‚úÖ **Environment Variables**: Sensitive data –≤ .env (–Ω–µ –≤ Git)
- ‚úÖ **Gitignore Protection**: Comprehensive .gitignore –¥–ª—è secrets
- ‚úÖ **GitHub Push Protection**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ leaked tokens
- ‚úÖ **Security Headers**: Helmet middleware –¥–ª—è –≤—Å–µ—Ö responses

## üìä Data Flow Architecture

```
User Input ‚Üí AI Processing ‚Üí Web Scraping ‚Üí Data Processing ‚Üí Storage ‚Üí Display
     ‚Üì              ‚Üì              ‚Üì              ‚Üì             ‚Üì         ‚Üì
Search Query ‚Üí OpenAI Assistant ‚Üí Apify Actors ‚Üí Deduplication ‚Üí Supabase ‚Üí Dashboard
     ‚Üì              ‚Üì              ‚Üì              ‚Üì             ‚Üì         ‚Üì
"–≥–∏–º–Ω–∞—Å—Ç–∏–∫–∞"  ‚Üí 3 optimized  ‚Üí Google Maps   ‚Üí Email extract ‚Üí Database ‚Üí Results UI
              queries        ‚Üí Web scraping  ‚Üí Filter/sort   ‚Üí Storage  ‚Üí Export
```

## üéÆ Development Commands

### **Application Lifecycle**
```bash
npm start          # Production server (port 3001)
npm run dev        # Development server (same as start)
```

### **Access Points**
- **Main App**: http://localhost:3001/index.html
- **Health Check**: http://localhost:3001/api/health
- **Test Forms**: http://localhost:3001/test-form.html
- **Pipeline Test**: http://localhost:3001/test-pipeline.html

### **Git Workflow**
```bash
# Auto-commit hooks –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤ .claude/settings.json
# –ö–∞–∂–¥–æ–µ Edit/Write ‚Üí automatic git add + commit + push
git status                    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
git log --oneline -10        # –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–º–º–∏—Ç—ã
```

## üîå API Architecture

### **Backend Proxy Endpoints**
```javascript
// Apify Integration
POST /api/apify/:actorId/runs                    // Single actor execution
POST /api/apify/:actorScope/:actorName/runs      // Scoped actor execution
GET  /api/apify/runs/:runId                      // Run status check
GET  /api/apify/datasets/:datasetId/items        // Data retrieval
GET  /api/apify/users/me                         // Account info

// OpenAI Integration (planned)
POST /api/openai/assistants/:assistantId/threads // Thread creation
POST /api/openai/threads/:threadId/messages     // Message sending

// System
GET  /api/health                                 // Health check
```

### **Authentication Headers**
```javascript
// Apify calls
headers: {
  'x-apify-token': process.env.APIFY_API_TOKEN
}

// OpenAI calls (server-side)
headers: {
  'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`,
  'OpenAI-Beta': 'assistants=v2'
}
```

### **Frontend API Clients Integration**
- **ApifyClient**: Google Maps + Web scraping —á–µ—Ä–µ–∑ proxy
- **OpenAIClient**: AI query generation —á–µ—Ä–µ–∑ secure endpoints
- **SupabaseClient**: Database operations + real-time subscriptions
- **PipelineOrchestrator**: Multi-stage workflow coordination

## ‚öôÔ∏è Production Settings Restoration

### **–í–ê–ñ–ù–û: –¢–µ–∫—É—â–∏–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –ª–∏–º–∏—Ç—ã**
```javascript
// TESTING –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (—Ç—Ä–µ–±—É—é—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è production):

// lib/server-pipeline-orchestrator.js:225
const fixedBuffer = 30; // TESTING: Reduced from 500 to 30

// lib/server-pipeline-orchestrator.js:74
const resultCount = 5; // TESTING: Reduced from 50 to 5

// lib/pipeline-orchestrator.js:250
const fixedBuffer = 30; // TESTING: Reduced from 500 to 30

// lib/server-apify-client.js:94
maxItems = 10, // TESTING: Reduced from 500 to 10
```

### **Production Restoration Commands**
```javascript
// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤ 4 —Ñ–∞–π–ª–∞—Ö:
fixedBuffer: 30 ‚Üí 500   // 16x —É–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
resultCount: 5 ‚Üí 50     // 10x —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –æ–±—â–µ–≥–æ –ª–∏–º–∏—Ç–∞
maxItems: 10 ‚Üí 500      // 50x —É–≤–µ–ª–∏—á–µ–Ω–∏–µ Apify –ª–∏–º–∏—Ç–∞

// –†–µ–∑—É–ª—å—Ç–∞—Ç: ~1500 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤–º–µ—Å—Ç–æ 30 (50x —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
```

## üêõ Recent Critical Fixes

### **Query Duplication Fix** (October 1, 2025)
- **Issue**: Google Maps –ø–∞—Ä—Å–∏–Ω–≥ –∑–∞–ø—É—Å–∫–∞–ª 6 –ø–æ–∏—Å–∫–æ–≤ –≤–º–µ—Å—Ç–æ 3 (–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤)
- **Root Cause**: OpenAI Assistant –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª 2 –≤–∞—Ä–∏–∞—Ü–∏–∏ –Ω–∞ –∫–∞–∂–¥—ã–π —è–∑—ã–∫ (3 —è–∑—ã–∫–∞ √ó 2 = 6)
- **Solution**: –î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ Set + hard limit 3 –∑–∞–ø—Ä–æ—Å–∞
- **Impact**: 50% —ç–∫–æ–Ω–æ–º–∏—è Apify —Ç–æ–∫–µ–Ω–æ–≤, –≤ 2 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ
- **Files**: `lib/server-pipeline-orchestrator.js:196-262`
- **Docs**: `database/QUERY_DUPLICATION_FIX.md`

### **Real-time Progress & Completion Fix** (October 1, 2025)
- **Issues Fixed**:
  1. Progress bar –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª—Å—è –≤ realtime (—Ç—Ä–µ–±–æ–≤–∞–ª—Å—è F5)
  2. –ù–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞ –ø–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ (–º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ, –∑–∞–ø–∏—Å–∏ –≤ –ë–î)
- **Solution**: Supabase Realtime –ø–æ–¥–ø–∏—Å–∫–∞ + –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ completion
- **Impact**: Real-time UX + –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–æ—Ç–µ—Ä–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- **Files**: `script.js:4922-5101`
- **Docs**: `database/REALTIME_PROGRESS_FIX.md`

### **Hybrid Monitoring System** (October 1, 2025)
- **Purpose**: Fallback –¥–ª—è Realtime –µ—Å–ª–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ Publication
- **Architecture**: Dual-path (Real-time + Polling –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫)
- **Files**: `script.js:4926-5076`, `server.js:1101-1121`
- **Docs**: `database/HYBRID_MONITORING_SYSTEM.md`

### **Double Pipeline Execution Fix** (October 1, 2025)
- **Issue**: –ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–ø—É—Å–∫–∞–ª—Å—è –î–í–ê–ñ–î–´ - 3 –∑–∞–ø—Ä–æ—Å–∞ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞, –ø–æ—Ç–æ–º –µ—â–µ 3 –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
- **Root Cause**: Race condition - –∑–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–≤–∞–ª–∞—Å—å –∫–∞–∫ `pending`, —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –≤—ã–ø–æ–ª–Ω—è–ª –µ–µ, –ù–û Background Worker —Ç–æ–∂–µ –ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞–ª `pending` –∑–∞–¥–∞—á—É
- **Solution**: –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å `running` –ü–û–°–õ–ï —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏, –î–û –∑–∞–ø—É—Å–∫–∞ pipeline
- **Impact**: 50% —ç–∫–æ–Ω–æ–º–∏—è (3 –∑–∞–ø—Ä–æ—Å–∞ –≤–º–µ—Å—Ç–æ 6), –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
- **Files**: `script.js:4353-4360`
- **Docs**: `database/DOUBLE_PIPELINE_EXECUTION_FIX.md`

---

## üèÜ Key Features & Capabilities

### **Business Intelligence Pipeline**
- **Multi-stage processing**: 6-—ç—Ç–∞–ø–Ω—ã–π AI Search workflow + 3-—ç—Ç–∞–ø–Ω—ã–π URL Parsing
- **AI-powered optimization**: OpenAI Assistant –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç search queries (—Å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–µ–π)
- **Scalable architecture**: Plan-aware resource management (FREE/PAID)
- **Universal Progress Bar**: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –ª—é–±–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —ç—Ç–∞–ø–æ–≤
  - AI Search: 7 stages (0% ‚Üí 14% ‚Üí 29% ‚Üí 43% ‚Üí 57% ‚Üí 71% ‚Üí 86% ‚Üí 100%)
  - URL Parsing: 3 stages (0% ‚Üí 33% ‚Üí 100%)
  - Automatic percentage calculation from `current/total`
  - Real-time database progress updates
  - Visual stage indicators with descriptions

### **Data Processing Capabilities**
- **Smart deduplication**: placeId-based —Å data merging
- **Contact extraction**: 5 —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –∏–∑–≤–ª–µ—á–µ–Ω–∏—è email/—Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤
- **Relevance scoring**: Keyword + location + rating algorithms
- **Export options**: CSV, JSON, database storage

### **Enterprise Integrations**
- **Google Workspace**: Gmail API + Drive API + OAuth 2.0
- **Telegram Bot**: Notifications + –∫–æ–º–∞–Ω–¥—ã + status updates
- **Supabase Stack**: Auth + Database + Real-time + Storage
- **Apify Platform**: Web scraping + Google Maps + Email extraction

### **Security & Compliance**
- **Zero client-side secrets**: –í—Å–µ API keys –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- **Row Level Security**: Database-level access control
- **Input sanitization**: Joi validation + XSS protection
- **GitHub security**: Push protection + secret scanning

## üöÄ Deployment & Scaling

### **Environment Configuration**

#### **Complete Environment Variables** (`.env.example` - 98 —Å—Ç—Ä–æ–∫)

**Supabase Configuration**:
```bash
SUPABASE_URL=https://your-project-ref.supabase.co
SUPABASE_ANON_KEY=your-anon-key-here
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key-here    # For server-side operations
SUPABASE_ACCESS_TOKEN=your-access-token-here
```

**OpenAI Configuration**:
```bash
OPENAI_API_KEY=sk-proj-your-api-key-here
OPENAI_ASSISTANT_ID=asst_your-assistant-id-here
OPENAI_VALIDATION_ASSISTANT_ID=asst_your-validation-assistant-id-here
```

**Apify Configuration**:
```bash
APIFY_API_TOKEN=apify_api_your-token-here
APIFY_GOOGLE_MAPS_ACTOR=compass/crawler-google-places
APIFY_DIRECT_ACTOR_ID=nwua9Gu5YrADL7ZDj
APIFY_USE_DIRECT_FALLBACK=true
```

**Railway Volume Configuration**:
```bash
VOLUME_PATH=/app/data                    # Railway Volume persistent storage
```

**Application Configuration**:
```bash
REGISTRATION_SECRET_CODE=GYMN-2025-SECURE
DB_SCHEMA=public
NODE_ENV=development                     # development|staging|production
APP_NAME=GYMNASTIKA Management Platform
DEBUG=true
AUTO_TEST_DB=true
```

**CORS & Security Configuration**:
```bash
CORS_ORIGIN=http://localhost:3001        # Development
# CORS_ORIGIN=https://your-domain.com    # Production
CORS_CREDENTIALS=true
ALLOWED_ORIGINS=http://localhost:3001,http://127.0.0.1:3001
ENABLE_SECURITY_HEADERS=true
CSP_ENABLED=true
HSTS_ENABLED=true
```

**Production Deployment Notes**:
- Update `NODE_ENV=production` –¥–ª—è –±–æ–µ–≤–æ–π —Å—Ä–µ–¥—ã
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å `CORS_ORIGIN` –∏ `ALLOWED_ORIGINS` –¥–ª—è —Å–≤–æ–∏—Ö –¥–æ–º–µ–Ω–æ–≤
- –í–∫–ª—é—á–∏—Ç—å –≤—Å–µ security headers –≤ production
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HTTPS –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤ production

---

## ‚ö†Ô∏è Critical Database Migrations

### **REQUIRED: Category ID Migration** (October 1, 2025)

#### **Problem**
After implementing category filtering functionality, parsing results fail to save with **400 Bad Request** error:
```
‚ùå Error inserting batch 1: Object
‚ùå Error saving results to database
```

**Root Cause**: Code attempts to save `category_id` field, but column doesn't exist in `parsing_results` table.

#### **Solution: Execute SQL Migration**

**Step 1**: Open Supabase SQL Editor (https://supabase.com/dashboard ‚Üí SQL Editor)

**Step 2**: Run migration from `database/ADD_CATEGORY_ID_COLUMN.sql`:

```sql
-- Add category_id column to parsing_results
ALTER TABLE parsing_results ADD COLUMN category_id UUID;

-- Add foreign key constraint
ALTER TABLE parsing_results
ADD CONSTRAINT parsing_results_category_id_fkey
FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE SET NULL;

-- Add index for performance
CREATE INDEX idx_parsing_results_category_id ON parsing_results(category_id);
```

**Step 3**: Verify migration:
```sql
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'parsing_results' AND column_name = 'category_id';
```

#### **Migration Files**
- üìú **SQL Script**: `database/ADD_CATEGORY_ID_COLUMN.sql`
- üìñ **Full Guide**: `database/CATEGORY_ID_MIGRATION_GUIDE.md`
- üìù **Quick Summary**: `database/CATEGORY_FIX_SUMMARY.md`

#### **Post-Migration Testing**
1. ‚úÖ Run new parsing task with category selected
2. ‚úÖ Verify contacts appear in Contacts section
3. ‚úÖ Test category filtering functionality
4. ‚úÖ Test CSV export with category column

#### **Impact**
- ‚úÖ Fixes 400 error when saving parsing results
- ‚úÖ Enables category filtering in History and Contacts
- ‚úÖ Adds category column to exported CSV files
- ‚úÖ Old records display as "–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" (No category)

**Migration Status**: ‚ö†Ô∏è **REQUIRED FOR NEW INSTALLATIONS**

---

### **Scaling Considerations**
- **Memory**: Pipeline –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–æ 2GB –¥–ª—è –±–æ–ª—å—à–∏—Ö datasets
- **Concurrency**: Apify plan –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å
- **Rate Limits**: OpenAI Assistant API + Apify actor limits
- **Database**: Supabase connection pooling + read replicas

### **Performance Optimization**
- **Client-side caching**: localStorage –¥–ª—è user settings
- **Background processing**: Worker threads –¥–ª—è heavy operations
- **Progressive loading**: Adaptive loader –¥–ª—è UI components
- **Resource monitoring**: Plan detection + automatic throttling

## üóÑÔ∏è Database Setup

### **–ö–†–ò–¢–ò–ß–ù–û: –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã parsing_tasks**

**–ü—Ä–æ–±–ª–µ–º–∞**: –¢–∞–±–ª–∏—Ü–∞ `parsing_tasks` –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ Supabase –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

**–†–µ—à–µ–Ω–∏–µ**:
1. –û—Ç–∫—Ä–æ–π—Ç–µ Supabase Dashboard ‚Üí SQL Editor
2. –í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –∏–∑ —Ñ–∞–π–ª–∞ `database/create_parsing_tasks_table.sql`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥–æ–π:
   ```sql
   SELECT COUNT(*) FROM parsing_tasks;
   ```

**–ß—Ç–æ —Å–æ–∑–¥–∞–µ—Ç—Å—è**:
- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ `parsing_tasks` —Å 17 –ø–æ–ª—è–º–∏
- ‚úÖ 4 –∏–Ω–¥–µ–∫—Å–∞ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (user_id, status, created_at, task_type)
- ‚úÖ RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (5 policies)
- ‚úÖ –¢—Ä–∏–≥–≥–µ—Ä auto-update –¥–ª—è `updated_at`
- ‚úÖ Service Role –¥–æ—Å—Ç—É–ø –¥–ª—è background worker

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã**:
```sql
- id (UUID, primary key)
- user_id (UUID, FK to auth.users)
- task_name, task_type ('ai-search' | 'url-parsing')
- search_query (NULL –¥–ª—è url-parsing)
- website_url (NULL –¥–ª—è ai-search)
- status ('pending' | 'running' | 'completed' | 'failed' | 'cancelled')
- current_stage, progress (JSONB)
- openai_thread_id, generated_queries, apify_runs
- collected_results, final_results (JSONB)
- error_message, retry_count
- created_at, updated_at, completed_at
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ RLS Policies**:
```sql
SELECT policyname FROM pg_policies WHERE tablename = 'parsing_tasks';
```

–î–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å:
- Users can view own parsing tasks
- Users can create own parsing tasks
- Users can update own parsing tasks
- Users can delete own parsing tasks
- Service role full access to parsing tasks

**–°–º. –ø–æ–ª–Ω—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é**: `database/README.md`

## üîß Troubleshooting Guide

### **Common Issues**

#### **500 Error: parsing_tasks table not found**
```javascript
Problem: ERROR 42P01: relation "parsing_tasks" does not exist
Solution: –í—ã–ø–æ–ª–Ω–∏—Ç—å SQL –º–∏–≥—Ä–∞—Ü–∏—é –∏–∑ database/create_parsing_tasks_table.sql
```

**–®–∞–≥–∏ —Ä–µ—à–µ–Ω–∏—è**:
1. Supabase Dashboard ‚Üí SQL Editor
2. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Å—å SQL –∏–∑ `database/create_parsing_tasks_table.sql`
3. –í—Å—Ç–∞–≤–∏—Ç—å –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å (Run)
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: `SELECT COUNT(*) FROM parsing_tasks;`
5. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

#### **URL Parsing Error: scrapeOrganizationDetails is not a function**
```javascript
Problem: TypeError: this.apifyClient.scrapeOrganizationDetails is not a function
Solution: –ò–°–ü–†–ê–í–õ–ï–ù–û - –º–µ—Ç–æ–¥ –±—ã–ª –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω –≤ scrapeWebsiteDetails
```

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –≤–µ—Ä—Å–∏–∏ 2025-10-01
- Client-side: `pipeline-orchestrator.js` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `scrapeWebsiteDetails()`
- Server-side: `server-pipeline-orchestrator.js` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç wrapper –º–µ—Ç–æ–¥

#### **URL Parsing –∑–∞–¥–∞—á–∏ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏–∏**
```javascript
Problem: URL parsing –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ, –Ω–æ –∑–∞–¥–∞—á–∞ –Ω–µ –≤–∏–¥–Ω–∞ –≤ "–ò—Å—Ç–æ—Ä–∏—è –∑–∞–¥–∞—á"
Solution: –ò–°–ü–†–ê–í–õ–ï–ù–û - UI —á–∏—Ç–∞–µ—Ç –∏–∑ parsing_tasks –≤–º–µ—Å—Ç–æ parsing_results
```

**–ü—Ä–∏—á–∏–Ω–∞**: UI —á–∏—Ç–∞–ª –∏—Å—Ç–æ—Ä–∏—é –∏–∑ —Å—Ç–∞—Ä–æ–π —Ç–∞–±–ª–∏—Ü—ã `parsing_results`, –∞ –Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `parsing_tasks`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è** (2025-10-01):
- ‚úÖ `loadHistoryData()` —Ç–µ–ø–µ—Ä—å —á–∏—Ç–∞–µ—Ç –∏–∑ `parsing_tasks` (script.js:1085-1113)
- ‚úÖ `viewTaskResults()` –∏–∑–≤–ª–µ–∫–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ `final_results` JSONB (script.js:1250-1298)
- ‚úÖ `loadContactsData()` —á–∏—Ç–∞–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç—ã –∏–∑ `parsing_tasks.final_results` (script.js:1387-1438)
- ‚úÖ `displayHistory()` –ø–µ—Ä–µ–¥–∞–µ—Ç `task_id` –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ (script.js:1563)

**–°–º. –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é**: `database/HISTORY_DISPLAY_FIX.md`

#### **Pipeline Stage Failures**
```javascript
// Stage 1: OpenAI Assistant –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç
Problem: API key invalid –∏–ª–∏ quota exceeded
Solution: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å OPENAI_API_KEY –≤ .env

// Stage 2: Apify actor timeout
Problem: Plan limits –∏–ª–∏ network issues
Solution: –£–≤–µ–ª–∏—á–∏—Ç—å timeout –∏–ª–∏ downgrade to FREE plan

// Stage 4: Web scraper returns empty results
Problem: Websites blocking automated access
Solution: Use residential proxies –∏–ª–∏ retry logic
```

#### **Authentication Issues**
```javascript
// Supabase connection failed
Problem: Invalid SUPABASE_URL –∏–ª–∏ ANON_KEY
Solution: Verify credentials –≤ config/env.js

// Google OAuth flow broken
Problem: GOOGLE_CLIENT_ID misconfigured
Solution: Check Google Cloud Console settings
```

#### **Performance Degradation**
```javascript
// Slow pipeline execution
Problem: Testing limits still active
Solution: Restore production values (see above)

// Memory leaks
Problem: Large datasets –Ω–µ –æ—Å–≤–æ–±–æ–∂–¥–∞—é—Ç—Å—è
Solution: Implement proper cleanup –≤ pipeline stages
```

### **Debug Commands**
```bash
# Check system status
curl http://localhost:3001/api/health

# View logs
tail -f logs/application.log

# Database connectivity
npm run test:db

# API keys validation
npm run test:apis
```

## üìö Documentation Structure

```
claudedocs/
‚îú‚îÄ‚îÄ PIPELINE-FIXES.md         # –ò—Å—Ç–æ—Ä–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π pipeline
‚îú‚îÄ‚îÄ WEB-SCRAPER-FIXES.md      # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è web scraper
‚îú‚îÄ‚îÄ SECURITY_CHECK_GUIDE.md   # –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –∞—É–¥–∏—Ç
‚îú‚îÄ‚îÄ SUPABASE_SETUP.md         # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
‚îú‚îÄ‚îÄ Google-OAuth-Setup-Guide.md # Google –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ test-pipeline.html        # Pipeline —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îú‚îÄ‚îÄ test-form.html           # UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
‚îî‚îÄ‚îÄ tests/                   # –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

database/
‚îú‚îÄ‚îÄ create_parsing_tasks_table.sql       # SQL –º–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è persistent parsing
‚îú‚îÄ‚îÄ HISTORY_DISPLAY_FIX.md              # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞–¥–∞—á
‚îú‚îÄ‚îÄ URL_PARSING_FIXES.md                # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è URL parsing —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞
‚îú‚îÄ‚îÄ URL_PARSING_PROGRESS.md             # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ –¥–ª—è URL parsing
‚îú‚îÄ‚îÄ STUCK_TASK_RECOVERY_FIX.md          # Stuck task detection –∏ retry –ª–æ–≥–∏–∫–∞
‚îú‚îÄ‚îÄ CONTEXT_AWARE_SEARCH_FEATURE.md     # Context-aware –ø–æ–∏—Å–∫ –ø–æ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
‚îú‚îÄ‚îÄ PIPELINE_CONCURRENCY_FIX.md         # Per-task orchestrator instances –¥–ª—è concurrency
‚îú‚îÄ‚îÄ REALTIME_PROGRESS_FIX.md            # Real-time progress updates –∏ completion flow
‚îú‚îÄ‚îÄ PURE_SERVER_SIDE_ARCHITECTURE.md    # Pure server-side execution (F5-proof)
‚îú‚îÄ‚îÄ DOUBLE_PIPELINE_EXECUTION_FIX.md    # Race condition fix (6 searches ‚Üí 3)
‚îú‚îÄ‚îÄ QUERY_DUPLICATION_FIX.md            # Query deduplication (50% cost savings)
‚îú‚îÄ‚îÄ COMPLETION_METHOD_NAMES_FIX.md      # Method names fix for task completion
‚îú‚îÄ‚îÄ PARSING_RESULTS_SCHEMA_FIX.md       # ‚úÖ DATABASE SAVE FIX (October 1, 2025)
‚îú‚îÄ‚îÄ EYE_ICON_FIX_SUMMARY.md             # ‚úÖ EYE ICON FIX (October 1, 2025)
‚îú‚îÄ‚îÄ CONTACTS_SECTION_FIX.md             # ‚úÖ CONTACTS SECTION FIX (October 1, 2025)
‚îú‚îÄ‚îÄ CROSS_BROWSER_DATA_FIX.md           # üî¥ CROSS-BROWSER FIX (October 1, 2025)
‚îú‚îÄ‚îÄ ALL_FIXES_SUMMARY.md                # ‚úÖ COMPLETE SUMMARY (October 1, 2025)
‚îî‚îÄ‚îÄ README.md                           # –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ database setup
```

## üéØ Development Patterns

### **Code Organization Rules**
- **Telegram settings**: –¢–æ–ª—å–∫–æ –≤ `GymnastikaPlatform` class
- **CSS spacing**: Parsing section –∫–∞–∫ —ç—Ç–∞–ª–æ–Ω –¥–ª—è –¥—Ä—É–≥–∏—Ö —Å–µ–∫—Ü–∏–π
- **Authentication**: `"${username} (${firstName} ${lastName})"` format
- **Error handling**: Browser console –¥–ª—è debugging + server logs

### **Git Workflow Standards**
- **Auto-commit hooks**: Edit/Write ‚Üí automatic commit + push
- **Branch strategy**: feature branches ‚Üí main via PR
- **Commit messages**: Descriptive —Å context –∏ impact
- **Security**: Never commit API keys –∏–ª–∏ sensitive data

---

## üèÅ Summary

**GYMNASTIKA Parsing Platform** –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π enterprise-grade —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ –±–∏–∑–Ω–µ—Å-–¥–∞–Ω–Ω—ã—Ö —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö AI —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π, web scraping –∏ cloud –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π.

**–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- üöÄ **Production-ready** –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å comprehensive security
- ü§ñ **AI-powered** –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ OpenAI Assistant API
- üîó **Multi-platform** –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (Google, Telegram, Supabase)
- üìä **Scalable** pipeline —Å plan-aware resource management
- üõ°Ô∏è **Security-first** –ø–æ–¥—Ö–æ–¥ —Å zero client-side secrets

**–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤ –∫ production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –ø–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤

---

## üîß –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (October 1, 2025)

### ‚úÖ Fix 0: Notification-Database Mismatch (October 1, 2025)
**–ü—Ä–æ–±–ª–µ–º–∞**: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 7 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –Ω–æ –≤ –±–∞–∑—É —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è 14
- **Root Cause**: –í –±–∞–∑—É —Å–æ—Ö—Ä–∞–Ω—è–ª–∏—Å—å –í–°–ï —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (—Å –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏ –∏ –±–µ–∑), –Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª–æ —Ç–æ–ª—å–∫–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å email
- **Solution**: –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è `results.filter(r => r.email || r.phone)` –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ –ë–î
- **Impact**: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Ç–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- **Files**: `script.js:5355-5378` (handleTaskCompletion)
- **Docs**: `database/NOTIFICATION_MISMATCH_FIX.md`

### ‚úÖ Fix 1: Database Save Error (400 Bad Request)
**–ü—Ä–æ–±–ª–µ–º–∞**: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–∞—Ä—Å–∏–Ω–≥–∞ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–ª–∏—Å—å –≤ `parsing_results` —Ç–∞–±–ª–∏—Ü—É
- **Root Cause**: Schema mismatch - –∫–æ–¥ –ø—ã—Ç–∞–ª—Å—è –≤—Å—Ç–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–ª–æ–Ω–∫–∏
- **Solution**: –ü–µ—Ä–µ–ø–∏—Å–∞–Ω `saveResultsToDatabase()` –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ä–µ–∞–ª—å–Ω–æ–π —Å—Ö–µ–º–µ —Ç–∞–±–ª–∏—Ü—ã
- **Impact**: Database saves —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ –æ—à–∏–±–æ–∫
- **Files**: `script.js:4928, 4952-5013`
- **Docs**: `database/PARSING_RESULTS_SCHEMA_FIX.md`

### ‚úÖ Fix 2: Eye Icon Shows 0 Results
**–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ üëÅ –≥–ª–∞–∑–∏–∫ –ø–æ–∫–∞–∑—ã–≤–∞–ª–æ "0 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤" –¥–∞–∂–µ –∫–æ–≥–¥–∞ –ø–∞—Ä—Å–∏–Ω–≥ —É—Å–ø–µ—à–µ–Ω
- **Root Cause**: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π user_id –≤ –∑–∞–ø—Ä–æ—Å–µ + –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ fallback –¥–ª—è –≤–ª–æ–∂–µ–Ω–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
- **Solution**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Supabase auth UUID + –æ–±—Ä–∞–±–æ—Ç–∫–∞ `final_results.results` –ø—É—Ç–∏
- **Impact**: Eye icon —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
- **Files**: `script.js:1321-1392`
- **Docs**: `database/EYE_ICON_FIX_SUMMARY.md`

### ‚úÖ Fix 3: Contacts Section Empty
**–ü—Ä–æ–±–ª–µ–º–∞**: –†–∞–∑–¥–µ–ª "–ö–æ–Ω—Ç–∞–∫—Ç—ã" –±—ã–ª –ø—É—Å—Ç, –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏—Å—å –∫–æ–Ω—Ç–∞–∫—Ç—ã
- **Root Cause**: –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ `parsing_tasks.final_results` –≤–º–µ—Å—Ç–æ `parsing_results` —Ç–∞–±–ª–∏—Ü—ã
- **Solution**: –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ `parsing_results` + fallback –Ω–∞ `parsing_tasks` –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- **Impact**: –ö–æ–Ω—Ç–∞–∫—Ç—ã —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –¥–ª—è –Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á
- **Files**: `script.js:1624-1712`
- **Docs**: `database/CONTACTS_SECTION_FIX.md`

### ‚úÖ Fix 4: Cross-Browser Data Not Visible üî¥ CRITICAL
**–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–∏ –≤—Ö–æ–¥–µ —Å –¥—Ä—É–≥–æ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–∞ —Ç–æ—Ç –∂–µ –∞–∫–∫–∞—É–Ω—Ç - –Ω–µ—Ç –Ω–∏–∫–∞–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- **Root Cause**: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å Supabase UUID, –∑–∞–≥—Ä—É–∑–∫–∞ —Å `this.currentUser?.id` (browser-specific)
- **Solution**: –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç Supabase auth UUID –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ
- **Impact**: –î–∞–Ω–Ω—ã–µ –≤–∏–¥–Ω—ã —Å –ª—é–±–æ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞/—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –¥–ª—è –æ–¥–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
- **Files**: `script.js:1095-1135, 5050-5056, 1626`
- **Docs**: `database/CROSS_BROWSER_DATA_FIX.md`

### ‚úÖ Fix 5: Export Contacts Button (October 1, 2025)
**–ü—Ä–æ–±–ª–µ–º–∞**: –ö–Ω–æ–ø–∫–∞ "–≠–∫—Å–ø–æ—Ä—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤" —Ä–∞–±–æ—Ç–∞–ª–∞, –Ω–æ –Ω–µ –±—ã–ª–∞ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞
- **Root Cause**: –û—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º —ç–∫—Å–ø–æ—Ä—Ç–µ
- **Solution**: –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ `sortContactsByDate()` –∏ alert-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- **Impact**: CSV —ç–∫—Å–ø–æ—Ä—Ç —Ç–µ–ø–µ—Ä—å –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å —Ç–∞–±–ª–∏—Ü–µ–π –ö–æ–Ω—Ç–∞–∫—Ç–æ–≤ (—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ + —Ñ–∏–ª—å—Ç—Ä—ã)
- **Features**:
  - ‚úÖ UTF-8 BOM –¥–ª—è Excel —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –∫–∏—Ä–∏–ª–ª–∏—Ü–µ–π
  - ‚úÖ 6 —Å—Ç–æ–ª–±—Ü–æ–≤: –ö–∞—Ç–µ–≥–æ—Ä–∏—è, –ù–∞–∑–≤–∞–Ω–∏–µ, Email, –û–ø–∏—Å–∞–Ω–∏–µ, –í–µ–±-—Å–∞–π—Ç, –î–∞—Ç–∞
  - ‚úÖ –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ CSV —Å–∏–º–≤–æ–ª–æ–≤ (–∑–∞–ø—è—Ç—ã–µ, –∫–∞–≤—ã—á–∫–∏, –ø–µ—Ä–µ–Ω–æ—Å—ã)
  - ‚úÖ Timestamp –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤: `contacts_YYYY-MM-DD_HH-MM-SS.csv`
- **Files**: `script.js:3209-3314` (exportContactsToCSV)
- **Docs**: `database/EXPORT_CONTACTS_FIX.md`

### ‚úÖ Feature 6: Email Deduplication System (October 1, 2025)
**–§—É–Ω–∫—Ü–∏—è**: –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –ø–æ email –∞–¥—Ä–µ—Å—É –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
- **Problem**: –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–∞—Ä—Å–∏–Ω–≥–∞—Ö –æ–¥–Ω–æ–π —Ç–µ–º–∞—Ç–∏–∫–∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã –¥—É–±–ª–∏—Ä–æ–≤–∞–ª–∏—Å—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- **Solution**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö email –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π —Å batch optimization
- **Algorithm**:
  1. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è email (lowercase + trim) –¥–ª—è case-insensitive —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
  2. Batch-–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö email –≤ –ë–î (–ø–æ 1000 –∑–∞ –∑–∞–ø—Ä–æ—Å)
  3. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ —á–µ—Ä–µ–∑ Set (O(1) lookup)
  4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
  5. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –Ω–æ–≤—ã—Ö/–¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- **Performance**:
  - ‚úÖ Batch queries: –¥–æ 1000 email –∑–∞ –∑–∞–ø—Ä–æ—Å (Supabase limit)
  - ‚úÖ Set-based deduplication: O(1) –≤–º–µ—Å—Ç–æ O(n)
  - ‚úÖ Batch insert: 100 –∑–∞–ø–∏—Å–µ–π –∑–∞ —Ä–∞–∑
  - ‚úÖ Case-insensitive: `Info@GYM.ae` = `info@gym.ae`
- **User Experience**:
  - ‚úÖ "–î–æ–±–∞–≤–ª–µ–Ω–æ X –Ω–æ–≤—ã—Ö –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤. –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ Y –¥—É–±–ª–∏–∫–∞—Ç–æ–≤."
  - ‚úÖ "–í—Å–µ N –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö" (–µ—Å–ª–∏ –≤—Å–µ –¥—É–±–ª–∏–∫–∞—Ç—ã)
  - ‚úÖ –î–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ –¥–ª—è debugging
- **Security**: RLS –∏–∑–æ–ª—è—Ü–∏—è - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–ª—å–∫–æ –≤ —Ä–∞–º–∫–∞—Ö —Ç–µ–∫—É—â–µ–≥–æ user_id
- **Files**: `script.js:5395-5543` (saveResultsToDatabase)
- **Docs**: `database/EMAIL_DEDUPLICATION_FEATURE.md`

### ‚úÖ Fix 7: Email Session State Persistence (October 2, 2025)
**–ü—Ä–æ–±–ª–µ–º–∞**: –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–∏—Å—å–º–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Å—Ç–∞–≤–∞–ª—Å—è –Ω–∞ —ç—Ç–∞–ø–µ 2 —Å –¥–∞–Ω–Ω—ã–º–∏ —Å—Ç–∞—Ä–æ–π –∫–∞–º–ø–∞–Ω–∏–∏
- **Root Cause #1**: `clearEmailSessionState()` –≤—ã–∑—ã–≤–∞–ª—Å—è, –Ω–æ `getCacheData()` –≤–æ–∑–≤—Ä–∞—â–∞–ª –ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç `{}` –≤–º–µ—Å—Ç–æ `null`
- **Root Cause #2**: –ü—Ä–æ–≤–µ—Ä–∫–∞ `if (!sessionState)` –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–∞ –¥–ª—è –ø—É—Å—Ç—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ (truthy value)
- **Solution #1**: –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `Object.keys(sessionState).length === 0` –≤ `restoreEmailSessionState()`
- **Solution #2**: –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∑–Ω–∞—á–∏–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö `(!sessionState.subject && !sessionState.step)`
- **Solution #3**: –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ `localStorage.removeItem('cache_email_session')` –≤ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∫ `invalidateCache()`
- **Impact**:
  - ‚úÖ –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–∏—Å—å–º–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ —á–∏—Å—Ç–æ–º —ç—Ç–∞–ø–µ 1
  - ‚úÖ –ü—Ä–∏ F5 –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Å—Ç–∞—Ä–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  - ‚úÖ –ù–æ–≤–∞—è –∫–∞–º–ø–∞–Ω–∏—è –≤—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –Ω—É–ª—è
- **Files**:
  - `script.js:820-828` (restoreEmailSessionState - empty object check)
  - `script.js:802-814` (clearEmailSessionState - full cleanup)
  - `script.js:5383-5385` (resetEmailWizard - clear session call)
- **Docs**: `database/EMAIL_SESSION_STATE_FIX.md`

### üìä –û–±—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
- ‚úÖ **Notification-Database match**: 7 vs 14 ‚Üí 7 vs 7 (—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ)
- ‚úÖ **Database save rate**: 0% ‚Üí 100%
- ‚úÖ **Eye icon success**: 0% ‚Üí 100%
- ‚úÖ **Contacts display**: 0% ‚Üí 100%
- ‚úÖ **Cross-browser data**: 0% ‚Üí 100% üî¥
- ‚úÖ **Data persistence**: Failed ‚Üí Complete
- ‚úÖ **Contact filtering**: –í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã ‚Üí –¢–æ–ª—å–∫–æ —Å email/phone
- ‚úÖ **Email session state**: Restores old campaign ‚Üí Clean step 1 after send
- ‚úÖ **Comprehensive documentation**: 7 –Ω–æ–≤—ã—Ö MD —Ñ–∞–π–ª–æ–≤

### ‚ö†Ô∏è –í–∞–∂–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
- **–°—Ç–∞—Ä—ã–µ –∑–∞–¥–∞—á–∏** (–¥–æ 1 –æ–∫—Ç—è–±—Ä—è): –º–æ–≥—É—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å 0 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–¥–∞–Ω–Ω—ã–µ –Ω–µ –±—ã–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∏–∑-–∑–∞ –±–∞–≥–∞)
- **–ù–æ–≤—ã–µ –∑–∞–¥–∞—á–∏** (–ø–æ—Å–ª–µ 1 –æ–∫—Ç—è–±—Ä—è): –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –ó–∞–ø—É—Å—Ç–∏—Ç—å –ù–û–í–£–Æ –∑–∞–¥–∞—á—É –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

**–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**:
- `database/ALL_FIXES_SUMMARY.md` (4 –ø–µ—Ä–≤—ã—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)
- `database/NOTIFICATION_MISMATCH_FIX.md` (5-–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)
- `database/EMAIL_SESSION_STATE_FIX.md` (7-–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)

---

**–°–æ–∑–¥–∞–Ω–æ —Å –ø–æ–º–æ—â—å—é Claude Code** | **GitHub**: https://github.com/gymnastika/parsing_project

## Data Flow

1. **User Input** ‚Üí Search query entered in frontend
2. **AI Processing** ‚Üí OpenAI Assistant generates optimized search queries  
3. **Web Scraping** ‚Üí Apify actors scrape Google Maps using generated queries
4. **Data Processing** ‚Üí Results processed and validated via second OpenAI Assistant
5. **Storage** ‚Üí Final data stored in Supabase database
6. **Display** ‚Üí Results shown in dashboard with progress tracking

## Key Features

### Main Architecture Class
- **`GymnastikaPlatform`** in `script.js` - Core application controller class that manages:
  - Authentication and user sessions
  - Navigation between sections (parsing, database, email, settings)
  - API client initialization with proper timing (1-1.5s delays)
  - Event binding and UI state management
  - Settings persistence (Telegram bot integration, etc.)

### Authentication
- Enhanced username display format: "username (firstName lastName)"
- Supabase profile integration with case-sensitive username preservation
- Dashboard access control with localStorage session management

### Multi-Client Integration
- **Apify Integration**: Web scraping with multiple specialized actors for Google Maps data extraction
- **OpenAI Integration**: AI-powered query generation and result validation using Assistant API
- **Supabase Integration**: Database operations and user authentication
- **Telegram Bot Integration**: Settings UI for bot API token configuration with inline testing

### UI Navigation Sections
- **Parsing** (`currentSection: 'parsing'`) - Main data extraction interface
- **Database** - Data management and viewing
- **Email** - Email campaign features
- **Settings** - System configuration including Telegram bot setup

### Progress Tracking
- Real-time progress updates during pipeline execution
- Stage-by-stage progress reporting (`PipelineOrchestrator.currentProgress`)
- Error handling and user feedback

## Configuration Requirements

### Required API Keys (in `config/env.js`)
```javascript
SUPABASE_URL: 'your-supabase-url'
SUPABASE_ANON_KEY: 'your-supabase-anon-key'  
OPENAI_API_KEY: 'sk-proj-...'
OPENAI_ASSISTANT_ID: 'asst_...'
OPENAI_VALIDATION_ASSISTANT_ID: 'asst_...'
APIFY_API_TOKEN: 'apify_api_...'
```

### API Key Replacement Guide

When setting up the project with client API keys, replace the following values:

#### 1. Supabase Configuration
**File**: `config/env.js`
- **SUPABASE_URL**: Replace with client's Supabase project URL (format: `https://xxxxx.supabase.co`)
- **SUPABASE_ANON_KEY**: Replace with client's Supabase anonymous/public key (starts with `eyJ...`)

#### 2. OpenAI Configuration  
**File**: `config/env.js`
- **OPENAI_API_KEY**: Replace with client's OpenAI API key (format: `sk-proj-...` or `sk-...`)
- **OPENAI_ASSISTANT_ID**: Replace with query generation assistant ID (format: `asst_...`)
- **OPENAI_VALIDATION_ASSISTANT_ID**: Replace with validation assistant ID (format: `asst_...`)

#### 3. Apify Configuration
**File**: `config/env.js`  
- **APIFY_API_TOKEN**: Replace with client's Apify API token (format: `apify_api_...`)

#### 4. Server Environment (Optional)
**File**: `.env` (create if doesn't exist)
```bash
# Server-side environment variables (optional fallback)
APIFY_API_TOKEN=apify_api_...
OPENAI_API_KEY=sk-proj-...
```

### Configuration Validation

After replacing API keys, verify configuration:

1. **Test Supabase Connection**: Visit `/index.html` and attempt login
2. **Test OpenAI Integration**: Generate search queries (should return 3 language objects)
3. **Test Apify Integration**: Run a search task (should detect plan type and execute scraping)
4. **Check Console**: Look for successful client initialization messages:
   - `‚úÖ Supabase client initialized`
   - `ü§ñ OpenAI client initialized with assistants`
   - `üï∑Ô∏è Apify client initialized`
   - `üìä Apify Plan Detected: FREE/PAID`

### Important Notes

- **Never commit API keys**: Keep `.env` in `.gitignore` 
- **Browser exposure**: `config/env.js` exposes keys to browser - ensure client understands security implications
- **Plan detection**: Apify client automatically detects FREE vs PAID plan and adjusts memory/concurrency limits
- **Assistant IDs**: Both OpenAI assistants must be pre-configured in client's OpenAI account with appropriate prompts

### Client Initialization Order
1. Environment config loaded (`config/env.js`)
2. Database clients initialized (`supabase-client.js`)
3. API clients initialized (`apify-client.js`, `openai-client.js`)  
4. Pipeline orchestrator created with client references
5. Frontend UI initialized with authentication check

## Dependencies

### Backend Dependencies
- `express`: Web server framework
- `cors`: Cross-origin resource sharing
- `node-fetch`: HTTP requests to external APIs

### Frontend Dependencies (CDN)
- `@supabase/supabase-js@2`: Database and authentication client

## Development Notes

- **No build process** - Direct file serving from root
- **Browser-based architecture** - All processing happens in browser except Apify proxy
- **Russian language interface** - UI text in Russian for target users
- **Single-page application** - Navigation handled via JavaScript without page reloads
- **Environment variables exposed** - `config/env.js` makes server environment available to browser (ensure no sensitive data exposure)

## Important Development Patterns

### Class Method Organization
- **Critical**: All Telegram settings methods must be in `GymnastikaPlatform` class, not `FormValidator` class
- Methods: `bindTelegramSettings()`, `loadTelegramSettings()`, `saveTelegramSettings()`, `testTelegramConnection()`, `validateTelegramToken()`, `setupTelegramSettings()`
- Use `this.telegramSettingsBound` flag to prevent duplicate event listener binding

### CSS Spacing Consistency
- **Parsing section spacing** is the reference standard for all other sections
- Settings forms should use compact spacing: `.form-group { gap: 0.25rem; margin-bottom: 0.5rem; }`
- Always match spacing between sections for UI consistency

### Authentication Flow
- Username display: `"${username} (${firstName} ${lastName})"` with case preservation
- Profile data loaded from Supabase `profiles` table with user foreign key
- Session management via localStorage with Supabase client integration

### Error Debugging
- Check method class placement first (most common issue)
- Use browser console for JavaScript errors and client status messages
- Verify API client initialization: `‚úÖ Supabase client initialized`, `ü§ñ OpenAI client initialized`, `üï∑Ô∏è Apify client initialized`

## Production Restoration Guide

**–í–ê–ñ–ù–û**: –°–ª–µ–¥—É—é—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è –±–æ–µ–≤–æ–π –≤–µ—Ä—Å–∏–∏:

### 1. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–∞—Ä—Å–∏–Ω–≥–∞

#### –§–∞–π–ª: `lib/server-pipeline-orchestrator.js`
**–°—Ç—Ä–æ–∫–∞ 225:** –ò–∑–º–µ–Ω–∏—Ç—å `fixedBuffer` –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ –±–æ–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
```javascript
// TESTING (—Ç–µ–∫—É—â–µ–µ):
const fixedBuffer = 30; // TESTING: Reduced from 500 to 30 (30/3=10 per query)

// PRODUCTION (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å):
const fixedBuffer = 500; // 500 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –±–æ–µ–≤–æ–π –≤–µ—Ä—Å–∏–∏
```

**–°—Ç—Ä–æ–∫–∞ 74:** –ò–∑–º–µ–Ω–∏—Ç—å `resultCount` –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ –±–æ–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
```javascript
// TESTING (—Ç–µ–∫—É—â–µ–µ):
const resultCount = 5; // TESTING: Reduced from 50 to 5 for testing

// PRODUCTION (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å):
const resultCount = 50; // Default result count, can be made configurable
```

#### –§–∞–π–ª: `lib/pipeline-orchestrator.js`
**–°—Ç—Ä–æ–∫–∞ 250:** –ò–∑–º–µ–Ω–∏—Ç—å `fixedBuffer` –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ –±–æ–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
```javascript
// TESTING (—Ç–µ–∫—É—â–µ–µ):
const fixedBuffer = 30; // TESTING: Reduced from 500 to 30

// PRODUCTION (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å):
const fixedBuffer = 500;
```

#### –§–∞–π–ª: `lib/server-apify-client.js`
**–°—Ç—Ä–æ–∫–∞ 94:** –ò–∑–º–µ–Ω–∏—Ç—å `maxItems` –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ –±–æ–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
```javascript
// TESTING (—Ç–µ–∫—É—â–µ–µ):
maxItems = 10, // TESTING: Reduced from 500 to 10 for faster testing

// PRODUCTION (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å):
maxItems = 500, // –ë–æ–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
```

### 2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

#### –§–∞–π–ª: `lib/pipeline-orchestrator.js`

**–°—Ç—Ä–æ–∫–∞ 311:** –í–µ—Ä–Ω—É—Ç—å updateProgress –≤—ã–∑–æ–≤ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
```javascript
// –¢–ï–ö–£–©–ï–ï (—É–±—Ä–∞–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è):
// REMOVED: updateProgress spam fix - only show at stage level, not per query

// –í–û–°–°–¢–ê–ù–û–í–ò–¢–¨ (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã –¥–µ—Ç–∞–ª—å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è):
this.updateProgress('apify-search', 2, 5, 
    `–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –ø–æ–∏—Å–∫: "${query}" [${language}/${region}] (–≥—Ä—É–ø–ø–∞ ${groupIndex + 1}/${queryObjects.length})`);
```

**–°—Ç—Ä–æ–∫–∞ 420:** –í–µ—Ä–Ω—É—Ç—å updateProgress –≤—ã–∑–æ–≤ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
```javascript
// –¢–ï–ö–£–©–ï–ï (—É–±—Ä–∞–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è):
// REMOVED: updateProgress spam fix - only show at stage level, not per query

// –í–û–°–°–¢–ê–ù–û–í–ò–¢–¨ (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã –¥–µ—Ç–∞–ª—å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è):
this.updateProgress('apify-search', 2, 5, 
    `–ü–æ–∏—Å–∫ ${currentQueryIndex}/${totalQueries}: "${query}" [${language}/${region}]`);
```

### 3. –†–µ–∑—É–ª—å—Ç–∞—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

–ü–æ—Å–ª–µ –≤–Ω–µ—Å–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:
- **Google Maps –ø–æ–∏—Å–∫**: 500 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å (–≤–º–µ—Å—Ç–æ 10)
- **–û–±—â–∏–π –æ–±—ä–µ–º**: ~1500 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è 3 –∑–∞–ø—Ä–æ—Å–æ–≤ (–≤–º–µ—Å—Ç–æ 30)
- **–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**: –£–≤–µ–ª–∏—á–∏—Ç—Å—è –¥–æ –ø–æ–ª–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∞ –¥–ª—è –±–æ–µ–≤–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**: –î–µ—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ (–µ—Å–ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã)

### 4. –ü–æ—Å–ª–µ –≤–Ω–µ—Å–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä: `npm start`
2. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å –Ω–µ–±–æ–ª—å—à–∏–º –∑–∞–ø—Ä–æ—Å–æ–º –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
3. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ø–æ–ª–Ω—ã–º –æ–±—ä–µ–º–æ–º –¥–∞–Ω–Ω—ã—Ö

**–ö–†–ò–¢–ò–ß–ù–û**: –≠—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ —É–≤–µ–ª–∏—á–∞—Ç –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –∏ —Ä–∞—Å—Ö–æ–¥ —Ç–æ–∫–µ–Ω–æ–≤/—Ä–µ—Å—É—Ä—Å–æ–≤!

---

## üîß –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (October 2, 2025)

### ‚úÖ Fix 5: Email Attachment Error –¥–ª—è —Ñ–∞–π–ª–æ–≤ <25MB
**–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ email —Å –≤–ª–æ–∂–µ–Ω–∏–µ–º <25MB –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞: `Cannot read properties of undefined (reading 'split')` –≤ google-oauth-hybrid.js:738
- **Root Cause**: –§–∞–π–ª—ã <25MB —Å–æ—Ö—Ä–∞–Ω—è–ª–∏—Å—å –∫–∞–∫ `tempFile` (File object), –Ω–æ –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —á–∏—Ç–∞–ª—Å—è –∫–∞–∫ base64
- **Solution**:
  1. –î–æ–±–∞–≤–ª–µ–Ω—ã null checks –≤ `google-oauth-hybrid.js` (lines 737-756)
  2. –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Ü–∏–∫–ª –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –≤–ª–æ–∂–µ–Ω–∏–π –≤ `sendEmailCampaign()` (lines 5220-5256)
  3. –°–æ–∑–¥–∞–Ω helper –º–µ—Ç–æ–¥ `readFileAsBase64()` –¥–ª—è —á—Ç–µ–Ω–∏—è File objects (lines 7990-8004)
- **Impact**: Email —Å –≤–ª–æ–∂–µ–Ω–∏—è–º–∏ <25MB —Ç–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- **Files**:
  - `script.js:5220-5256` - Attachment preparation loop
  - `script.js:7990-8004` - readFileAsBase64() helper method
  - `lib/google-oauth-hybrid.js:737-756` - Null checks for attachment.content

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏**:
```javascript
// Helper –º–µ—Ç–æ–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç FileReader API
readFileAsBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file); // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç data:image/png;base64,...
    });
}

// –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –≤–ª–æ–∂–µ–Ω–∏–π –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
for (const attachment of this.currentEmailCampaign.attachments || []) {
    if (attachment.tempFile) {
        const content = await this.readFileAsBase64(attachment.tempFile);
        preparedAttachments.push({
            filename: attachment.originalName,
            mimeType: attachment.type,
            content: content // base64 data URL
        });
    }
}
```

### ‚úÖ Fix 6: 400 Bad Request - Missing userId in Task Creation (October 7, 2025)
**–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥ –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞ 400 Bad Request
```
Failed to load resource: the server responded with a status of 400 ()
‚ùå Task creation error: Error: Failed to create task in database
‚ùå Missing required fields: { userId: false, taskData: true }
```

- **Root Cause**: –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª—è–ª `userId: this.currentUser?.id`, –Ω–æ `this.currentUser` –±—ã–ª `undefined` –∏–ª–∏ `null`
  - –ü—Ä–∏ `userId: undefined`, JSON.stringify() –Ω–µ –≤–∫–ª—é—á–∞–µ—Ç —ç—Ç–æ –ø–æ–ª–µ –≤ —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞
  - –°–µ—Ä–≤–µ—Ä –ø–æ–ª—É—á–∞–ª —Ç–æ–ª—å–∫–æ `taskData` –±–µ–∑ `userId` ‚Üí –æ—Ç–∫–ª–æ–Ω—è–ª –∑–∞–ø—Ä–æ—Å —Å 400 –æ—à–∏–±–∫–æ–π

- **Solution**:
  1. –ü–æ–ª—É—á–µ–Ω–∏–µ `userId` –Ω–∞–ø—Ä—è–º—É—é –∏–∑ Supabase session –≤ –º–æ–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
  2. –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å –ø–æ–Ω—è—Ç–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ–± –æ—à–∏–±–∫–µ
  3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –æ–±–∞ –º–µ—Ç–æ–¥–∞: `startParsing()` –∏ `startUrlParsing()`

- **Impact**:
  - ‚úÖ `userId` —Ç–µ–ø–µ—Ä—å –í–°–ï–ì–î–ê –ø–æ–ª—É—á–∞–µ—Ç—Å—è –∏–∑ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π Supabase —Å–µ—Å—Å–∏–∏
  - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∑–∞–ø—Ä–æ—Å–∞
  - ‚úÖ –ó–∞–ø—Ä–æ—Å –≤—Å–µ–≥–¥–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–∞–ª–∏–¥–Ω—ã–π `userId` ‚Üí —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –µ–≥–æ
  - ‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫ 400

- **Files Modified**:
  - `script.js:6209-6241` - –ú–µ—Ç–æ–¥ `startParsing()` —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π userId
  - `script.js:6280-6310` - –ú–µ—Ç–æ–¥ `startUrlParsing()` —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π userId

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏**:
```javascript
// –ë–´–õ–û (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ - userId –º–æ–∂–µ—Ç –±—ã—Ç—å undefined):
body: JSON.stringify({
    userId: this.currentUser?.id,  // ‚ùå undefined –µ—Å–ª–∏ –Ω–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω
    taskData: taskData
})

// –°–¢–ê–õ–û (–ø—Ä–∞–≤–∏–ª—å–Ω–æ - –≤—Å–µ–≥–¥–∞ –≤–∞–ª–∏–¥–Ω—ã–π userId):
// –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Å–µ—Å—Å–∏—é –∏–∑ Supabase
const { data: { session }, error: sessionError } = await this.supabase.auth.getSession();

if (sessionError || \!session?.user) {
    throw new Error("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.");
}

const userId = session.user.id;  // ‚úÖ –í—Å–µ–≥–¥–∞ –≤–∞–ª–∏–¥–Ω—ã–π UUID
console.log("‚úÖ Authenticated user ID:", userId);

body: JSON.stringify({
    userId: userId,  // ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç
    taskData: taskData
})
```

**Server-side Validation** (`server.js:1049-1052`):
```javascript
if (\!userId || \!taskData) {
    console.error("‚ùå Missing required fields:", { userId: \!\!userId, taskData: \!\!taskData });
    return res.status(400).json({ error: "userId and taskData are required" });
}
```

---

**–°–æ–∑–¥–∞–Ω–æ —Å –ø–æ–º–æ—â—å—é Claude Code** | **GitHub**: https://github.com/gymnastika/parsing_project
