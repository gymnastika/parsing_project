# üîÑ Stuck Task Recovery - Page Reload Resilience

## –î–∞—Ç–∞: 2025-10-01
## –°—Ç–∞—Ç—É—Å: ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

---

## üìã –ü—Ä–æ–±–ª–µ–º–∞ –∏–∑ –æ—Ç—á–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**:
> "–°–º–æ—Ç—Ä–∏, –∫–∞–∫–∞—è —É –º–µ–Ω—è –ø—Ä–æ–±–ª–µ–º–∞ –≤–æ–∑–Ω–∏–∫–ª–∞. –Ø –∫–æ–≥–¥–∞ —Å–µ–π—á–∞—Å –∑–∞–ø—É—Å—Ç–∏–ª –Ω–æ–≤—ã–π –ø–∞—Ä—Å–∏–Ω–≥, —É –º–µ–Ω—è –ø–æ–∫–∞–∑–∞–ª—Å—è –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä, –∏ —è –æ–±–Ω–æ–≤–∏–ª —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä —É –º–µ–Ω—è –æ—Å—Ç–∞–ª—Å—è, –Ω–æ –≤ –∫–æ–Ω—Å–æ–ª–∏ —è –Ω–µ –≤–∏–∂—É —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∞–ª—Å—è —É –º–µ–Ω—è –≤–æ—Ç —ç—Ç–æ—Ç –ø–∞—Ä—Å–∏–Ω–≥. –ò, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ, —É –º–µ–Ω—è –æ–Ω –ø—Ä–æ—Å—Ç–æ –∑–∞–≤–∏—Å. –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä. –ü—Ä–∏ —ç—Ç–æ–º Supabase —É –º–µ–Ω—è –≤—Ä–æ–¥–µ –∫–∞–∫ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ, –Ω–æ –æ–Ω–∏ –∫–∞–∫-—Ç–æ —Ç–æ –ª–∏ –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã, —Ç–æ –ª–∏ —á–µ –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ —Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º –∏ –ø–æ–ª—É—á–∞–µ—Ç—Å—è –æ—á–µ–Ω—å —Å—Ç—Ä–∞–Ω–Ω–æ. –¢–æ –µ—Å—Ç—å —É –º–µ–Ω—è –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–µ–ø–µ—Ä—å –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –≤–∏—Å–∏—Ç –∏ –Ω–∏–∫–∞–∫ –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è."

**–î–∞–Ω–Ω—ã–µ –∏–∑ Supabase**:
```json
{
  "id": "34d6886d-326d-484a-ac78-a15288881632",
  "task_name": "–ù–µ —Ç–µ—Å—Ç",
  "task_type": "ai-search",
  "search_query": "–°–ø–∞—Ä—Å–∏ –º–∏–Ω–∏—Å—Ç–µ—Ä—Å—Ç–≤–∞ —Å–ø–æ—Ä—Ç–∞ –≤ –¥—É–±–∞–µ",
  "status": "running",
  "current_stage": "query-generation",
  "progress": {
    "stage": "query-generation",
    "total": 100,
    "current": 25,
    "message": "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –ò–ò..."
  },
  "updated_at": "2025-10-01 07:10:46.507049+00"
}
```

### –°–∏–º–ø—Ç–æ–º—ã:
1. ‚ùå –ó–∞–ø—É—â–µ–Ω –ø–∞—Ä—Å–∏–Ω–≥ ‚Üí –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä 25%
2. ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–∏–ª —Å—Ç—Ä–∞–Ω–∏—Ü—É (F5)
3. ‚ùå –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä "–∑–∞–≤–∏—Å" –Ω–∞ 25%
4. ‚ùå –í –∫–æ–Ω—Å–æ–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞
5. ‚ùå –ó–∞–¥–∞—á–∞ –≤ Supabase: `status='running'`
6. ‚ùå –ù–∞ Apify –∑–∞–ø—Ä–æ—Å—ã –Ω–µ —É—à–ª–∏ (–ø–∞—Ä—Å–∏–Ω–≥ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è)
7. ‚ùå –ó–∞–¥–∞—á–∞ –±–æ–ª—å—à–µ –Ω–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—Ä—É–µ—Ç

---

## üîç Root Cause Analysis

### **–ü—Ä–æ–±–ª–µ–º–∞ 1: Client-side –ø–∞—Ä—Å–∏–Ω–≥ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ F5**

**–¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**:
```javascript
// script.js - Client-side execution
async startAISearch(params) {
    // 1. Create task in DB (status='pending')
    const response = await fetch('/api/parsing-tasks', ...);
    const { taskId } = await response.json();
    this.currentTaskId = taskId;

    // 2. Start client-side pipeline
    await this.orchestrator.runFullPipeline({
        searchQuery: params.searchQuery,
        taskId: taskId,
        updateProgress: (progress) => {
            // Update UI progress bar
            this.updateModernProgress(progress);
        }
    });
}
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ F5**:
1. JavaScript –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è
2. `this.orchestrator.runFullPipeline()` promise –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç—Å—è
3. `this.currentTaskId` —Ç–µ—Ä—è–µ—Ç—Å—è
4. –ó–∞–¥–∞—á–∞ –≤ DB –æ—Å—Ç–∞–µ—Ç—Å—è `status='running'`
5. –ü–∞—Ä—Å–∏–Ω–≥ –ù–ï –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è

### **–ü—Ä–æ–±–ª–µ–º–∞ 2: checkAndRestoreActiveTask —Ç–æ–ª—å–∫–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç UI**

**–¢–µ–∫—É—â–∏–π –∫–æ–¥** (`script.js:4837-4917`):
```javascript
async checkAndRestoreActiveTask() {
    const activeTasks = await fetch('/api/parsing-tasks/active?userId=...');

    if (activeTasks.length > 0) {
        const activeTask = activeTasks[0];
        this.currentTaskId = activeTask.id;

        // ‚úÖ Show progress bar
        progressBar.classList.add('active');

        // ‚úÖ Restore progress state
        this.updateModernProgress({
            stage: activeTask.current_stage,
            current: activeTask.progress.current,
            message: activeTask.progress.message
        });

        // ‚ùå BUT: Does NOT resume parsing!
        // No call to orchestrator.runFullPipeline()
    }
}
```

**–ü—Ä–æ–±–ª–µ–º–∞**: –¢–æ–ª—å–∫–æ UI –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è, –Ω–æ —Å–∞–º –ø—Ä–æ—Ü–µ—Å—Å –ø–∞—Ä—Å–∏–Ω–≥–∞ –ù–ï –≤–æ–∑–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è.

### **–ü—Ä–æ–±–ª–µ–º–∞ 3: Background Worker –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ pending**

**–¢–µ–∫—É—â–∏–π –∫–æ–¥** (`lib/background-worker.js:101-140`):
```javascript
async pollForTasks() {
    // Get ONLY pending tasks
    const pendingTasks = await this.tasksService.getPendingTasks(availableSlots);

    // Process each pending task
    for (const task of pendingTasks) {
        await this.startTaskProcessing(task);
    }
}
```

**–ü—Ä–æ–±–ª–µ–º–∞**:
- Worker –∑–∞–±–∏—Ä–∞–µ—Ç —Ç–æ–ª—å–∫–æ `status='pending'` –∑–∞–¥–∞—á–∏
- –ö–æ–≥–¥–∞ –∑–∞–¥–∞—á–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è ‚Üí `status='running'`
- –ü—Ä–∏ F5 –∑–∞–¥–∞—á–∞ –æ—Å—Ç–∞–µ—Ç—Å—è `status='running'`
- Worker **–ù–ï** –ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–≤–∏—Å—à–∏–µ `running` –∑–∞–¥–∞—á–∏

### **–ü—Ä–æ–±–ª–µ–º–∞ 4: –ù–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –∑–∞–≤–∏—Å—à–∏—Ö –∑–∞–¥–∞—á**

**–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –º–µ—Ç–æ–¥—ã**:
- `getStuckTasks()` - –Ω–∞–π—Ç–∏ –∑–∞–≤–∏—Å—à–∏–µ running –∑–∞–¥–∞—á–∏
- `resetStuckTask()` - —Å–±—Ä–æ—Å–∏—Ç—å –æ–±—Ä–∞—Ç–Ω–æ –≤ pending
- `checkAndResetStuckTasks()` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ó–∞–¥–∞—á–∏ –æ—Å—Ç–∞—é—Ç—Å—è "–∑–∞–≤–∏—Å—à–∏–º–∏" –Ω–∞–≤—Å–µ–≥–¥–∞.

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### **Architecture: Stuck Task Recovery System**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  User starts parsing                    ‚îÇ
‚îÇ  status: pending ‚Üí running              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  User presses F5 (page reload)          ‚îÇ
‚îÇ  Client-side process terminated         ‚îÇ
‚îÇ  Task stuck in status='running'         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Background Worker polls (every 5s)     ‚îÇ
‚îÇ  Checks: updated_at > 2 minutes old?    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ               ‚îÇ
        ‚ñº               ‚ñº
   NOT STUCK        STUCK TASK
   (skip)           (reset it)
        ‚îÇ               ‚îÇ
        ‚îÇ               ‚ñº
        ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ    ‚îÇ  Reset to pending        ‚îÇ
        ‚îÇ    ‚îÇ  Increment retry_count   ‚îÇ
        ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ               ‚îÇ
        ‚îÇ               ‚ñº
        ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ    ‚îÇ  Worker picks up task    ‚îÇ
        ‚îÇ    ‚îÇ  Processes from scratch  ‚îÇ
        ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                            ‚îÇ
                                            ‚ñº
                                ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                ‚îÇ  Parsing completes‚îÇ
                                ‚îÇ  status='completed'‚îÇ
                                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üèóÔ∏è Implementation

### **1. ParsingTasksService: Add getStuckTasks()**

**File**: `lib/parsing-tasks-service.js` (lines 199-230)

```javascript
/**
 * Get stuck/orphaned running tasks (for recovery)
 * Tasks in 'running' status for more than timeout threshold
 */
async getStuckTasks(timeoutMinutes = 5, limit = 10) {
    if (!this.enabled) {
        return [];
    }

    try {
        // Calculate cutoff time (tasks older than this are considered stuck)
        const cutoffTime = new Date(Date.now() - timeoutMinutes * 60 * 1000).toISOString();

        const { data, error } = await this.supabase
            .from('parsing_tasks')
            .select('*')
            .eq('status', 'running')
            .lt('updated_at', cutoffTime) // updated_at older than cutoff
            .order('created_at', { ascending: true })
            .limit(limit);

        if (error) {
            throw error;
        }

        return data || [];

    } catch (error) {
        console.error('‚ùå Error getting stuck tasks:', error);
        throw error;
    }
}
```

**–õ–æ–≥–∏–∫–∞**:
- –ò—â–µ—Ç –∑–∞–¥–∞—á–∏ —Å `status='running'`
- `updated_at` —Å—Ç–∞—Ä—à–µ —á–µ–º `timeoutMinutes` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5 –º–∏–Ω—É—Ç)
- –≠—Ç–æ –∑–Ω–∞—á–∏—Ç –∑–∞–¥–∞—á–∞ –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–∞—Å—å –∏ –∑–∞—Å—Ç—Ä—è–ª–∞
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–æ `limit` –∑–∞–≤–∏—Å—à–∏—Ö –∑–∞–¥–∞—á

### **2. ParsingTasksService: Add resetStuckTask()**

**File**: `lib/parsing-tasks-service.js` (lines 348-369)

```javascript
/**
 * Reset stuck task back to pending for retry
 */
async resetStuckTask(taskId) {
    try {
        const task = await this.getTask(taskId);
        if (!task) {
            throw new Error('Task not found');
        }

        const retryCount = (task.retry_count || 0) + 1;

        return this.updateTask(taskId, {
            status: 'pending',
            retry_count: retryCount,
            error_message: `Task was stuck in 'running' status, reset to pending (retry ${retryCount})`
        });
    } catch (error) {
        console.error(`‚ùå Error resetting stuck task ${taskId}:`, error);
        throw error;
    }
}
```

**–õ–æ–≥–∏–∫–∞**:
- –ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â—É—é –∑–∞–¥–∞—á—É
- –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ—Ç `retry_count`
- –ú–µ–Ω—è–µ—Ç `status='pending'`
- –î–æ–±–∞–≤–ª—è–µ—Ç `error_message` —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º
- Worker –ø–æ–¥—Ö–≤–∞—Ç–∏—Ç –∑–∞–¥–∞—á—É –≤ —Å–ª–µ–¥—É—é—â–µ–º poll cycle

### **3. BackgroundWorker: Add checkAndResetStuckTasks()**

**File**: `lib/background-worker.js` (lines 143-188)

```javascript
/**
 * Check for stuck tasks and reset them to pending
 */
async checkAndResetStuckTasks() {
    try {
        // Get tasks stuck in 'running' status for more than 2 minutes
        const stuckTasks = await this.tasksService.getStuckTasks(2, 10);

        if (stuckTasks.length === 0) {
            return;
        }

        console.log(`‚ö†Ô∏è Found ${stuckTasks.length} stuck tasks, resetting to pending...`);

        for (const task of stuckTasks) {
            try {
                // Skip if we're currently processing this task
                if (this.runningTasks.has(task.id)) {
                    console.log(`‚è≠Ô∏è Task ${task.id} is actually running, skipping reset`);
                    continue;
                }

                // Check retry limit
                const retryCount = task.retry_count || 0;
                if (retryCount >= this.maxRetries) {
                    console.log(`‚ùå Task ${task.id} exceeded max retries (${this.maxRetries}), marking as failed`);
                    await this.tasksService.markAsFailed(
                        task.id,
                        `Task exceeded max retry limit (${this.maxRetries} retries)`
                    );
                    continue;
                }

                // Reset task to pending for retry
                console.log(`üîÑ Resetting stuck task ${task.id} to pending (retry ${retryCount + 1}/${this.maxRetries})`);
                await this.tasksService.resetStuckTask(task.id);

            } catch (error) {
                console.error(`‚ùå Error resetting stuck task ${task.id}:`, error);
            }
        }

    } catch (error) {
        console.error('‚ùå Error checking stuck tasks:', error);
    }
}
```

**–õ–æ–≥–∏–∫–∞**:
1. **–ù–∞—Ö–æ–¥–∏—Ç –∑–∞–≤–∏—Å—à–∏–µ –∑–∞–¥–∞—á–∏**: `getStuckTasks(2 –º–∏–Ω—É—Ç—ã, 10 –∑–∞–¥–∞—á)`
2. **–ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ**: –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ –≤ `runningTasks` Map ‚Üí skip
3. **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç retry limit**: –ï—Å–ª–∏ `retry_count >= maxRetries` ‚Üí mark as failed
4. **–°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –≤ pending**: `resetStuckTask()` –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏

### **4. BackgroundWorker: Integrate into pollForTasks()**

**File**: `lib/background-worker.js` (lines 101-141)

```javascript
async pollForTasks() {
    try {
        // Check if tasks service is available
        if (!this.tasksService.enabled) {
            return;
        }

        // STEP 1: Check for stuck tasks and reset them
        await this.checkAndResetStuckTasks();

        // STEP 2: Check if we have capacity for more tasks
        const availableSlots = this.maxConcurrentTasks - this.runningTasks.size;
        if (availableSlots <= 0) {
            return;
        }

        // STEP 3: Get pending tasks from database
        const pendingTasks = await this.tasksService.getPendingTasks(availableSlots);

        if (pendingTasks.length === 0) {
            return;
        }

        console.log(`üìã Found ${pendingTasks.length} pending tasks, processing...`);

        // STEP 4: Start processing each task
        for (const task of pendingTasks) {
            if (this.runningTasks.size >= this.maxConcurrentTasks) {
                break;
            }

            await this.startTaskProcessing(task);
        }

    } catch (error) {
        console.error('‚ùå Error polling for tasks:', error);
    }
}
```

**–ö–ª—é—á–µ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ**:
- **STEP 1** –¥–æ–±–∞–≤–ª–µ–Ω: `checkAndResetStuckTasks()` –ü–ï–†–ï–î –ø–æ–ª—É—á–µ–Ω–∏–µ–º pending –∑–∞–¥–∞—á
- –ö–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ worker –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∑–∞–≤–∏—Å—à–∏–µ –∑–∞–¥–∞—á–∏
- –ï—Å–ª–∏ –Ω–∞—Ö–æ–¥–∏—Ç ‚Üí reset to pending
- –ó–∞—Ç–µ–º –ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç —ç—Ç–∏ –∑–∞–¥–∞—á–∏ –∫–∞–∫ –æ–±—ã—á–Ω—ã–µ pending

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### **Test Case 1: Stuck Task Recovery After F5**

**–®–∞–≥–∏**:
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å AI Search –ø–∞—Ä—Å–∏–Ω–≥
2. –î–æ–∂–¥–∞—Ç—å—Å—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ (~25%, "query-generation")
3. –ù–∞–∂–∞—Ç—å F5 (–æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É)
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Supabase: –∑–∞–¥–∞—á–∞ `status='running'`
5. –ü–æ–¥–æ–∂–¥–∞—Ç—å 2+ –º–∏–Ω—É—Ç—ã
6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å server logs

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:
- ‚úÖ Background Worker –ª–æ–≥–∏: `‚ö†Ô∏è Found 1 stuck tasks, resetting to pending...`
- ‚úÖ –õ–æ–≥: `üîÑ Resetting stuck task ... to pending (retry 1/3)`
- ‚úÖ –ó–∞–¥–∞—á–∞ –≤ Supabase: `status='pending'`, `retry_count=1`
- ‚úÖ Worker –ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–¥–∞—á—É: `üìã Found 1 pending tasks, processing...`
- ‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è —Å –Ω–∞—á–∞–ª–∞
- ‚úÖ –ó–∞–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è: `status='completed'`

### **Test Case 2: Progress Bar Recovery**

**–®–∞–≥–∏**:
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥
2. –ù–∞–∂–∞—Ç—å F5
3. –ü–æ–¥–æ–∂–¥–∞—Ç—å –ø–æ–∫–∞ Background Worker reset –∑–∞–¥–∞—á—É
4. –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–Ω–æ–≤–∞

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:
- ‚úÖ –ü–æ—Å–ª–µ –≤—Ç–æ—Ä–æ–≥–æ F5: –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è
- ‚úÖ `checkAndRestoreActiveTask()` –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á
- ‚úÖ UI —á–∏—Å—Ç—ã–π –∏ –≥–æ—Ç–æ–≤ –∫ –Ω–æ–≤–æ–º—É –ø–∞—Ä—Å–∏–Ω–≥—É
- ‚úÖ –ó–∞–¥–∞—á–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤ —Ñ–æ–Ω–µ

### **Test Case 3: Retry Limit Exceeded**

**–®–∞–≥–∏**:
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥
2. –ù–∞–∂–∞—Ç—å F5 (retry_count=1)
3. –ü–æ–¥–æ–∂–¥–∞—Ç—å 2 –º–∏–Ω—É—Ç—ã
4. –ù–∞–∂–∞—Ç—å F5 —Å–Ω–æ–≤–∞ (retry_count=2)
5. –ü–æ–¥–æ–∂–¥–∞—Ç—å 2 –º–∏–Ω—É—Ç—ã
6. –ù–∞–∂–∞—Ç—å F5 —Ç—Ä–µ—Ç–∏–π —Ä–∞–∑ (retry_count=3)
7. –ü–æ–¥–æ–∂–¥–∞—Ç—å 2 –º–∏–Ω—É—Ç—ã

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:
- ‚úÖ –ü–æ—Å–ª–µ 3 retry –ø–æ–ø—ã—Ç–æ–∫: –∑–∞–¥–∞—á–∞ marked as failed
- ‚úÖ –õ–æ–≥: `‚ùå Task ... exceeded max retries (3), marking as failed`
- ‚úÖ Supabase: `status='failed'`, `error_message='Task exceeded max retry limit (3 retries)'`
- ‚úÖ Worker –±–æ–ª—å—à–µ –Ω–µ —Ç—Ä–æ–≥–∞–µ—Ç —ç—Ç—É –∑–∞–¥–∞—á—É

### **Test Case 4: Task Actually Running (False Positive)**

**–®–∞–≥–∏**:
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (—á–µ—Ä–µ–∑ Background Worker)
2. –ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è > 2 –º–∏–Ω—É—Ç—ã (–±–æ–ª—å—à–æ–π –ø–∞—Ä—Å–∏–Ω–≥)
3. Worker poll cycle –ø—Ä–æ–≤–µ—Ä—è–µ—Ç stuck tasks

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:
- ‚úÖ Worker: `‚è≠Ô∏è Task ... is actually running, skipping reset`
- ‚úÖ –ó–∞–¥–∞—á–∞ –ù–ï —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –≤ pending
- ‚úÖ –ü—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
- ‚úÖ `runningTasks.has(taskId)` –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç reset

### **Test Case 5: Concurrent Stuck Tasks**

**–®–∞–≥–∏**:
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å 5 –ø–∞—Ä—Å–∏–Ω–≥–æ–≤
2. –ù–∞–∂–∞—Ç—å F5 –¥–ª—è –≤—Å–µ—Ö
3. –ü–æ–¥–æ–∂–¥–∞—Ç—å 2 –º–∏–Ω—É—Ç—ã

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:
- ‚úÖ Worker: `‚ö†Ô∏è Found 5 stuck tasks, resetting to pending...`
- ‚úÖ –í—Å–µ 5 –∑–∞–¥–∞—á reset to pending
- ‚úÖ Worker –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ 2 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ (`maxConcurrentTasks=2`)
- ‚úÖ –û—Å—Ç–∞–ª—å–Ω—ã–µ 3 –≤ –æ—á–µ—Ä–µ–¥–∏
- ‚úÖ –í—Å–µ –∑–∞–≤–µ—Ä—à–∞—é—Ç—Å—è —É—Å–ø–µ—à–Ω–æ

---

## üìä Configuration

### **Background Worker Settings** (`server.js:30-34`)

```javascript
const backgroundWorker = new BackgroundWorker({
    pollInterval: 5000,        // Check every 5 seconds
    maxConcurrentTasks: 2,     // Process max 2 tasks simultaneously
    maxRetries: 3              // Retry failed tasks up to 3 times
});
```

### **Stuck Task Detection**

```javascript
// In checkAndResetStuckTasks()
const stuckTasks = await this.tasksService.getStuckTasks(2, 10);
//                                                       ‚Üë  ‚Üë
//                                                       ‚îÇ  ‚îÇ
//                                      Timeout: 2 minutes ‚îÇ
//                                                Limit: 10 tasks
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- **`timeoutMinutes: 2`** - –ó–∞–¥–∞—á–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è –∑–∞–≤–∏—Å—à–µ–π –µ—Å–ª–∏ `updated_at` —Å—Ç–∞—Ä—à–µ 2 –º–∏–Ω—É—Ç
- **`limit: 10`** - –ú–∞–∫—Å–∏–º—É–º 10 –∑–∞–≤–∏—Å—à–∏—Ö –∑–∞–¥–∞—á –∑–∞ –æ–¥–∏–Ω poll cycle
- **`maxRetries: 3`** - –ü–æ—Å–ª–µ 3 –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ ‚Üí failed

### **Poll Cycle Flow**

```
Every 5 seconds:
‚îú‚îÄ Check stuck tasks (updated_at > 2 min old)
‚îú‚îÄ Reset stuck tasks to pending (retry_count++)
‚îú‚îÄ Get pending tasks (status='pending')
‚îú‚îÄ Process up to 2 tasks concurrently
‚îî‚îÄ Wait 5 seconds ‚Üí repeat
```

---

## üîó –°–≤—è–∑—å —Å –¥—Ä—É–≥–∏–º–∏ features

### **–°–≤—è–∑—å —Å TASK_DELETION_FEATURE.md**:
- **–¢–æ—Ç feature**: –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
- **–≠—Ç–æ—Ç fix**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å—à–∏—Ö –∑–∞–¥–∞—á
- **–ü–∞—Ç—Ç–µ—Ä–Ω**: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –∑–∞–¥–∞—á

### **–°–≤—è–∑—å —Å URL_PARSING_DATA_FIX.md**:
- **–¢–æ—Ç fix**: Email –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
- **–≠—Ç–æ—Ç fix**: –ü–∞—Ä—Å–∏–Ω–≥ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –¥–∞–∂–µ –ø–æ—Å–ª–µ F5
- **–ü–∞—Ç—Ç–µ—Ä–Ω**: Resilient task processing

### **–°–≤—è–∑—å —Å PHONE_FIELD_REMOVAL.md**:
- **–¢–æ—Ç fix**: –£–ø—Ä–æ—â–µ–Ω–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- **–≠—Ç–æ—Ç fix**: –£–ø—Ä–æ—â–µ–Ω–∏–µ recovery –ª–æ–≥–∏–∫–∏
- **–ü–∞—Ç—Ç–µ—Ä–Ω**: Simplicity ‚Üí Reliability

**–û–±—â–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω**: Background processing + Resilient task management = –ù–∞–¥–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞

---

## üí° Future Enhancements

### **1. Real-time Progress Sync via WebSockets**

**–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –µ—Å–ª–∏ –ø–∞—Ä—Å–∏–Ω–≥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

**–†–µ—à–µ–Ω–∏–µ**:
```javascript
// Server-side: WebSocket broadcast
wss.clients.forEach(client => {
    if (client.userId === task.user_id) {
        client.send(JSON.stringify({
            type: 'progress',
            taskId: task.id,
            progress: { stage, current, total, message }
        }));
    }
});

// Client-side: WebSocket listener
const ws = new WebSocket('ws://localhost:3001');
ws.onmessage = (event) => {
    const data = JSON.parse(event.data);
    if (data.type === 'progress') {
        this.updateModernProgress(data.progress);
    }
};
```

### **2. Task Pause/Resume Instead of Full Restart**

**–ü—Ä–æ–±–ª–µ–º–∞**: Stuck task –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Å –Ω—É–ª—è

**–†–µ—à–µ–Ω–∏–µ**:
```javascript
// Save checkpoint before F5
async saveCheckpoint(taskId, checkpoint) {
    await this.tasksService.updateTask(taskId, {
        checkpoint: {
            stage: 'apify-search',
            completedQueries: ['query1', 'query2'],
            collectedResults: [...]
        }
    });
}

// Resume from checkpoint
async resumeFromCheckpoint(task) {
    const checkpoint = task.checkpoint;
    if (checkpoint) {
        // Continue from last saved stage
        await this.orchestrator.runPipelineFromStage(checkpoint.stage, checkpoint);
    } else {
        // Start from beginning
        await this.orchestrator.runFullPipeline(...);
    }
}
```

### **3. Dead Letter Queue for Failed Tasks**

**–ü—Ä–æ–±–ª–µ–º–∞**: –ü–æ—Å–ª–µ 3 retries –∑–∞–¥–∞—á–∞ –ø—Ä–æ—Å—Ç–æ fails –±–µ–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä—É—á–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

**–†–µ—à–µ–Ω–∏–µ**:
```javascript
// Create DLQ table
CREATE TABLE dead_letter_queue (
    id UUID PRIMARY KEY,
    task_id UUID,
    task_data JSONB,
    failure_reason TEXT,
    retry_count INT,
    created_at TIMESTAMP
);

// Move failed task to DLQ
async moveToDeadLetterQueue(task) {
    await this.supabase.from('dead_letter_queue').insert({
        task_id: task.id,
        task_data: task,
        failure_reason: task.error_message,
        retry_count: task.retry_count
    });
}

// Manual recovery UI
<button onclick="retryFromDLQ(taskId)">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –≤—Ä—É—á–Ω—É—é</button>
```

### **4. Health Check Endpoint**

**–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ—Ç —Å–ø–æ—Å–æ–±–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å Background Worker –∏–∑–≤–Ω–µ

**–†–µ—à–µ–Ω–∏–µ**:
```javascript
// Server endpoint
app.get('/api/health/worker', (req, res) => {
    const status = backgroundWorker.healthCheck();
    res.json({
        isRunning: status.isRunning,
        runningTasks: status.runningTasksCount,
        lastPollTime: status.lastPollTime,
        stuckTasksFound: status.stuckTasksFound,
        uptime: status.uptime
    });
});

// Client monitoring
setInterval(async () => {
    const health = await fetch('/api/health/worker').then(r => r.json());
    if (!health.isRunning) {
        alert('‚ö†Ô∏è Background Worker –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!');
    }
}, 60000); // Check every minute
```

---

## üéØ Summary

**–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (F5) –ø–∞—Ä—Å–∏–Ω–≥ –ø—Ä–µ—Ä—ã–≤–∞–ª—Å—è, –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä "–∑–∞–≤–∏—Å–∞–ª", –∑–∞–¥–∞—á–∞ –æ—Å—Ç–∞–≤–∞–ª–∞—Å—å –≤ `status='running'` –∏ –±–æ–ª—å—à–µ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∞—Å—å.

**Root Causes**:
1. **Client-side –ø–∞—Ä—Å–∏–Ω–≥**: –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ, F5 –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å
2. **UI-only recovery**: `checkAndRestoreActiveTask()` –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–ª —Ç–æ–ª—å–∫–æ UI, –Ω–µ –ø—Ä–æ—Ü–µ—Å—Å
3. **Worker ignores running**: Background Worker –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª —Ç–æ–ª—å–∫–æ `pending` –∑–∞–¥–∞—á–∏
4. **No stuck detection**: –û—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª –º–µ—Ö–∞–Ω–∏–∑–º –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –∑–∞–≤–∏—Å—à–∏—Ö –∑–∞–¥–∞—á

**–†–µ—à–µ–Ω–∏–µ**:
1. ‚úÖ `getStuckTasks(timeoutMinutes)` - –Ω–∞—Ö–æ–¥–∏—Ç –∑–∞–¥–∞—á–∏ –≤ `running` —Å—Ç–∞—Ä—à–µ N –º–∏–Ω—É—Ç
2. ‚úÖ `resetStuckTask(taskId)` - —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∑–∞–¥–∞—á—É –≤ `pending` —Å increment `retry_count`
3. ‚úÖ `checkAndResetStuckTasks()` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ Background Worker
4. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ `pollForTasks()` - STEP 1 –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π pending –∑–∞–¥–∞—á
5. ‚úÖ Retry limit enforcement - –ø–æ—Å–ª–µ 3 –ø–æ–ø—ã—Ç–æ–∫ ‚Üí failed
6. ‚úÖ False positive prevention - –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç —Ä–µ–∞–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞—é—â–∏–µ –∑–∞–¥–∞—á–∏

**–†–µ–∑—É–ª—å—Ç–∞—Ç**:
- ‚úÖ –ó–∞–¥–∞—á–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ F5 (—á–µ—Ä–µ–∑ 2+ –º–∏–Ω—É—Ç—ã)
- ‚úÖ Worker reset –∑–∞–¥–∞—á—É –≤ pending
- ‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è —Å –Ω–∞—á–∞–ª–∞
- ‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –∏—Å—á–µ–∑–∞–µ—Ç –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º F5 (–∑–∞–¥–∞—á–∞ —É–∂–µ processing –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
- ‚úÖ Retry limit –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ retry
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ resilient –∫ page reloads

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- Poll interval: **5 —Å–µ–∫—É–Ω–¥**
- Stuck timeout: **2 –º–∏–Ω—É—Ç—ã**
- Max retries: **3 –ø–æ–ø—ã—Ç–∫–∏**
- Max concurrent: **2 –∑–∞–¥–∞—á–∏**

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: 2025-10-01
**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (F5 test)
**–ö–æ–º–º–∏—Ç**: –ì–æ—Ç–æ–≤ –∫ push

**–°–æ–∑–¥–∞–Ω–æ —Å –ø–æ–º–æ—â—å—é Claude Code** | **GitHub**: https://github.com/gymnastika/parsing_project
