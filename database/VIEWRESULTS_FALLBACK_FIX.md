# üîß View Results Fallback Logic Fix

## –î–∞—Ç–∞: 2025-10-01
## –°—Ç–∞—Ç—É—Å: ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

---

## üìã –ü—Ä–æ–±–ª–µ–º–∞ –∏–∑ –æ—Ç—á–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**: "–£ –º–µ–Ω—è —Å–µ–π—á–∞—Å –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –≥–ª–∞–∑–∏–∫, –µ—Å–ª–∏ —É –º–µ–Ω—è, –Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–∏–ø –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø–æ URL, —É –º–µ–Ω—è –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –ø–æ—á–µ–º—É-—Ç–æ –¥–∞–Ω–Ω—ã–µ —Å –ø–∞—Ä—Å–∏–Ω–≥–∞ AI –ø–æ–∏—Å–∫"

### –°–∏–º–ø—Ç–æ–º—ã:
1. ‚ùå –ö–ª–∏–∫ –Ω–∞ üëÅ —É **URL Parsing** –∑–∞–¥–∞—á–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç **AI Search –¥–∞–Ω–Ω—ã–µ**
2. ‚ùå –û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã (–∏–∑ –¥—Ä—É–≥–æ–≥–æ —Ç–∏–ø–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞)
3. ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–∏–¥–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–≤–æ–µ–≥–æ URL –ø–∞—Ä—Å–∏–Ω–≥–∞
4. ‚ùå –ü—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –∑–∞–¥–∞—á–∞—Ö —Å **–æ–¥–∏–Ω–∞–∫–æ–≤—ã–º** `task_name` ("–¢–µ—Å—Ç")

---

## üîç Root Cause Analysis

### –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

**LEGACY_DATA_MIGRATION_FIX.md** (–ø—Ä–µ–¥—ã–¥—É—â–∏–π fix):
- –î–æ–±–∞–≤–∏–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∫—É legacy –¥–∞–Ω–Ω—ã—Ö –∏–∑ `parsing_results`
- –†–µ–∞–ª–∏–∑–æ–≤–∞–ª–∏ fallback: –µ—Å–ª–∏ –∑–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ `parsing_tasks` ‚Üí –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ `parsing_results`

**–ü—Ä–æ–±–ª–µ–º–Ω–∞—è –ª–æ–≥–∏–∫–∞** (script.js:1308-1359):
```javascript
async viewTaskResults(taskName, taskId = null) {
    let results = [];

    // If taskId is provided, load from parsing_tasks
    if (taskId) {
        const { data: tasks } = await this.supabase
            .from('parsing_tasks')
            .select('*')
            .eq('id', taskId)
            .limit(1);

        if (tasks && tasks.length > 0) {
            results = tasks[0].final_results || [];
        }
    }

    // ‚ùå –ü–†–û–ë–õ–ï–ú–ê: Fallback —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ –ø—É—Å—Ç—ã—Ö results!
    if (!taskId || results.length === 0) {
        // Load from parsing_results (legacy)
        const { data: legacyResults } = await this.supabase
            .from('parsing_results')
            .select('*')
            .eq('task_name', taskName)  // ‚ùå –¢–æ–ª—å–∫–æ –ø–æ –∏–º–µ–Ω–∏!
            ...
    }
}
```

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ:

**–®–∞–≥ 1**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—É—Å–∫–∞–µ—Ç URL Parsing —Å `task_name: "–¢–µ—Å—Ç"`
- –°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ `parsing_tasks` —Å `taskId` (UUID)
- `task_type: 'url-parsing'`
- `final_results: []` (–ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤, –ø–∞—Ä—Å–∏–Ω–≥ –µ—â–µ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω –ò–õ–ò –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –±–µ–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤)

**–®–∞–≥ 2**: –í `parsing_results` –ï–°–¢–¨ legacy AI Search –∑–∞–¥–∞—á–∞ "–¢–µ—Å—Ç"
- 7 –∑–∞–ø–∏—Å–µ–π —Å `task_name: "–¢–µ—Å—Ç"`
- `original_query: "—Å–ø–∞—Ä—Å–∏ –º–∏–Ω–∏—Å—Ç–µ—Ä—Å—Ç–∞–≤ —Å–ø–æ—Ä—Ç–∞ –≤ –¥—É–±–∞–µ"`
- AI Search –∫–æ–Ω—Ç–∞–∫—Ç—ã (emails, websites, etc.)

**–®–∞–≥ 3**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–∫–∞–µ—Ç üëÅ –Ω–∞ URL Parsing –∑–∞–¥–∞—á–µ "–¢–µ—Å—Ç"
- –í—ã–∑–æ–≤: `viewTaskResults('–¢–µ—Å—Ç', taskId)`
- `taskId` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Üí –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∏–∑ `parsing_tasks`
- –ù–∞—Ö–æ–¥–∏—Ç –∑–∞–¥–∞—á—É, –Ω–æ `final_results = []` (–ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤)
- **–£—Å–ª–æ–≤–∏–µ `results.length === 0` ‚Üí TRUE!** ‚ùå
- Fallback –Ω–∞ `parsing_results` —Å `task_name: "–¢–µ—Å—Ç"`
- –ù–∞—Ö–æ–¥–∏—Ç 7 AI Search legacy –∑–∞–ø–∏—Å–µ–π
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç **AI Search –¥–∞–Ω–Ω—ã–µ –≤–º–µ—Å—Ç–æ URL Parsing** ‚ùå

### Root Cause: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —É—Å–ª–æ–≤–∏–µ fallback

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥**:
```javascript
if (!taskId || results.length === 0) {
    // ‚ùå Fallback –¥–∞–∂–µ –∫–æ–≥–¥–∞ –∑–∞–¥–∞—á–∞ –Ω–∞–π–¥–µ–Ω–∞ –Ω–æ –ø—É—Å—Ç–∞!
}
```

**–õ–æ–≥–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞**:
- `results.length === 0` –æ–∑–Ω–∞—á–∞–µ—Ç "—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—É—Å—Ç—ã"
- –ù–æ —ç—Ç–æ –ù–ï –æ–∑–Ω–∞—á–∞–µ—Ç "–∑–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"!
- URL Parsing –∑–∞–¥–∞—á–∞ —Å –ø—É—Å—Ç—ã–º `final_results` ‚Üí –≤–∞–ª–∏–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–ø–∞—Ä—Å–∏–Ω–≥ –±–µ–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤)
- Fallback –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¢–û–õ–¨–ö–û –¥–ª—è legacy –∑–∞–¥–∞—á (`taskId === null`), –ù–ï –¥–ª—è –ø—É—Å—Ç—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è**:
1. URL Parsing –∑–∞–¥–∞—á–∞ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º –∏–º–µ–Ω–µ–º –∫–∞–∫ AI Search –∑–∞–¥–∞—á–∞ ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç AI Search –¥–∞–Ω–Ω—ã–µ
2. –õ—é–±–∞—è –∑–∞–¥–∞—á–∞ —Å `final_results: []` ‚Üí —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π fallback
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –î–†–£–ì–û–ì–û —Ç–∏–ø–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞

---

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### –†–µ—à–µ–Ω–∏–µ: –£–±—Ä–∞—Ç—å —É—Å–ª–æ–≤–∏–µ `results.length === 0` –∏–∑ fallback –ª–æ–≥–∏–∫–∏

**–§–∞–π–ª**: `script.js:1308-1371`

**–ë—ã–ª–æ**:
```javascript
let results = [];

if (taskId) {
    const { data: tasks } = await ...;
    if (tasks && tasks.length > 0) {
        results = tasks[0].final_results || [];
    }
}

// ‚ùå Fallback –ø—Ä–∏ –ø—É—Å—Ç—ã—Ö results –ò–õ–ò –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ taskId
if (!taskId || results.length === 0) {
    // Load from parsing_results (legacy)
}

if (results.length > 0) {
    this.viewResults(results);
} else {
    this.showError('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
}
```

**–°—Ç–∞–ª–æ**:
```javascript
let results = [];
let taskFound = false;

// Case 1: TaskId provided - load from parsing_tasks ONLY
if (taskId) {
    const { data: tasks, error } = await this.supabase
        .from('parsing_tasks')
        .select('*')
        .eq('id', taskId)
        .limit(1);

    if (error) {
        console.error('‚ùå Error fetching task:', error);
        this.showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤');
        return;
    }

    if (tasks && tasks.length > 0) {
        taskFound = true;  // ‚úÖ –ó–∞–¥–∞—á–∞ –Ω–∞–π–¥–µ–Ω–∞!
        results = tasks[0].final_results || [];
        console.log(`üîç Found task from parsing_tasks with ${results.length} results`);
    }
}

// Case 2: No taskId (legacy data) - load from parsing_results
if (!taskId) {  // ‚úÖ –¢–û–õ–¨–ö–û –∫–æ–≥–¥–∞ taskId –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç!
    console.log('üìú Loading legacy data from parsing_results...');

    const { data: legacyResults, error: legacyError } = await this.supabase
        .from('parsing_results')
        .select('*')
        .eq('task_name', taskName)
        .eq('user_id', this.currentUser?.id);

    if (legacyError) {
        console.error('‚ùå Error fetching legacy results:', legacyError);
        this.showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤');
        return;
    }

    if (legacyResults && legacyResults.length > 0) {
        // Transform legacy results to new format
        results = legacyResults.map(item => ({
            organization_name: item.organization_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è',
            email: item.email || '',
            phone: item.phone || '',
            description: item.description || '',
            website: item.website || item.source_url || '',
            country: item.country || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ',
            parsing_timestamp: item.parsing_timestamp || item.created_at
        }));
        console.log(`üìú Found ${results.length} legacy results from parsing_results`);
    }
}

// Display results or appropriate error
if (results && results.length > 0) {
    this.viewResults(results);
} else if (taskFound) {
    // ‚úÖ Task exists but has no results - specific message
    this.showError('–ó–∞–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –±–µ–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–ª–∏ –µ—â–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è');
} else {
    this.showError('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
}
```

### –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:

1. **–§–ª–∞–≥ `taskFound`**: –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –±—ã–ª–∞ –ª–∏ –Ω–∞–π–¥–µ–Ω–∞ –∑–∞–¥–∞—á–∞ –≤ `parsing_tasks`
   ```javascript
   if (tasks && tasks.length > 0) {
       taskFound = true;  // ‚úÖ –ó–∞–¥–∞—á–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
   }
   ```

2. **–£–±—Ä–∞–Ω–æ —É—Å–ª–æ–≤–∏–µ `results.length === 0` –∏–∑ fallback**:
   ```javascript
   // –ë–´–õ–û: if (!taskId || results.length === 0)
   // –°–¢–ê–õ–û: if (!taskId)  ‚úÖ –¢–æ–ª—å–∫–æ –¥–ª—è legacy!
   ```

3. **–£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö**:
   - `taskFound && results.length === 0` ‚Üí "–ó–∞–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –±–µ–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–ª–∏ –µ—â–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è"
   - `!taskFound` ‚Üí "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"

### –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:

**–°—Ü–µ–Ω–∞—Ä–∏–π A**: URL Parsing –∑–∞–¥–∞—á–∞ —Å `taskId` –∏ –ø—É—Å—Ç—ã–º–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
1. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏–∑ `parsing_tasks` –ø–æ `taskId`
2. –ù–∞—Ö–æ–¥–∏—Ç –∑–∞–¥–∞—á—É ‚Üí `taskFound = true`
3. `final_results = []` ‚Üí `results.length === 0`
4. **–ù–ï fallback –Ω–∞ `parsing_results`!** ‚úÖ
5. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç: "–ó–∞–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –±–µ–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–ª–∏ –µ—â–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è"

**–°—Ü–µ–Ω–∞—Ä–∏–π B**: Legacy AI Search –∑–∞–¥–∞—á–∞ –ë–ï–ó `taskId`
1. `taskId === null` ‚Üí —Å—Ä–∞–∑—É –∏–¥–µ—Ç –≤ –±–ª–æ–∫ legacy
2. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏–∑ `parsing_results` –ø–æ `task_name`
3. –ù–∞—Ö–æ–¥–∏—Ç 7 AI Search –∑–∞–ø–∏—Å–µ–π
4. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç AI Search —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã ‚úÖ

**–°—Ü–µ–Ω–∞—Ä–∏–π C**: URL Parsing –∑–∞–¥–∞—á–∞ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
1. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏–∑ `parsing_tasks` –ø–æ `taskId`
2. –ù–∞—Ö–æ–¥–∏—Ç –∑–∞–¥–∞—á—É ‚Üí `taskFound = true`
3. `final_results = [...]` ‚Üí `results.length > 0`
4. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç URL Parsing —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã ‚úÖ

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: URL Parsing –∑–∞–¥–∞—á–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ (–Ω–µ AI Search)
**–®–∞–≥–∏**:
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å URL –ø–∞—Ä—Å–∏–Ω–≥ —Å `task_name: "–¢–µ—Å—Ç"`
2. –î–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (–∏–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –±–µ–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤)
3. –ü–µ—Ä–µ–π—Ç–∏ –≤ "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö" ‚Üí "–ò—Å—Ç–æ—Ä–∏—è –∑–∞–¥–∞—á"
4. –ù–∞–π—Ç–∏ –∑–∞–¥–∞—á—É —Å —Ç–∏–ø–æ–º "–ü–æ URL"
5. –ù–∞–∂–∞—Ç—å üëÅ

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:
- ‚úÖ –ï—Å–ª–∏ –µ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç URL Parsing —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
- ‚úÖ –ï—Å–ª–∏ –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–ó–∞–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –±–µ–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–ª–∏ –µ—â–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è"
- ‚úÖ **–ù–ï** –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç AI Search –¥–∞–Ω–Ω—ã–µ –∏–∑ `parsing_results`

### –¢–µ—Å—Ç 2: Legacy AI Search –∑–∞–¥–∞—á–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ
**–®–∞–≥–∏**:
1. –ù–∞–π—Ç–∏ legacy –∑–∞–¥–∞—á—É "–¢–µ—Å—Ç" —Å —Ç–∏–ø–æ–º "AI –ü–æ–∏—Å–∫"
2. –ù–∞–∂–∞—Ç—å üëÅ

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:
- ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç 7 AI Search –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∏–∑ `parsing_results`
- ‚úÖ –ö–æ–Ω—Ç–∞–∫—Ç—ã: shop@mtnextreme.com, info@adsc.gov.ae, –∏ —Ç.–¥.
- ‚úÖ Legacy fallback —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### –¢–µ—Å—Ç 3: –û–¥–∏–Ω–∞–∫–æ–≤—ã–µ task_name –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç
**–®–∞–≥–∏**:
1. –°–æ–∑–¥–∞—Ç—å AI Search –∑–∞–¥–∞—á—É —Å –∏–º–µ–Ω–µ–º "–¢–µ—Å—Ç2"
2. –°–æ–∑–¥–∞—Ç—å URL Parsing –∑–∞–¥–∞—á—É —Å –∏–º–µ–Ω–µ–º "–¢–µ—Å—Ç2"
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –æ–±–µ –∑–∞–¥–∞—á–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏
4. –ö–ª–∏–∫–Ω—É—Ç—å üëÅ –Ω–∞ –∫–∞–∂–¥–æ–π

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:
- ‚úÖ AI Search "–¢–µ—Å—Ç2" ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç AI Search —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
- ‚úÖ URL Parsing "–¢–µ—Å—Ç2" ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç URL Parsing —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (–∏–ª–∏ "–±–µ–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤")
- ‚úÖ –ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –º–µ–∂–¥—É –∑–∞–¥–∞—á–∞–º–∏ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ –∏–º–µ–Ω–∞–º–∏

### –¢–µ—Å—Ç 4: –ü—É—Å—Ç—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–µ —Ç—Ä–∏–≥–≥–µ—Ä—è—Ç fallback
**–®–∞–≥–∏**:
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥ –∫–æ—Ç–æ—Ä—ã–π –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è –±–µ–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ `final_results = []` –≤ `parsing_tasks`
3. –ö–ª–∏–∫–Ω—É—Ç—å üëÅ

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:
- ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç: "–ó–∞–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –±–µ–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–ª–∏ –µ—â–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è"
- ‚úÖ **–ù–ï** –∑–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ `parsing_results`
- ‚úÖ **–ù–ï** –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç legacy –¥–∞–Ω–Ω—ã–µ —Å —Ç–∞–∫–∏–º –∂–µ –∏–º–µ–Ω–µ–º

---

## üìä –í–ª–∏—è–Ω–∏–µ –Ω–∞ —Å–∏—Å—Ç–µ–º—É

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚ùå URL Parsing –∑–∞–¥–∞—á–∏ —Å –ø—É—Å—Ç—ã–º `final_results` —Ç—Ä–∏–≥–≥–µ—Ä–∏–ª–∏ fallback –Ω–∞ `parsing_results`
- ‚ùå –ü–æ–∫–∞–∑—ã–≤–∞–ª–∏—Å—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –î–†–£–ì–û–ì–û —Ç–∏–ø–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ (AI Search –≤–º–µ—Å—Ç–æ URL Parsing)
- ‚ùå –£—Å–ª–æ–≤–∏–µ `results.length === 0` –≤—ã–∑—ã–≤–∞–ª–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π fallback
- ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–µ–ª –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ üëÅ

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚úÖ Fallback –Ω–∞ `parsing_results` –¢–û–õ–¨–ö–û –∫–æ–≥–¥–∞ `taskId === null` (legacy –∑–∞–¥–∞—á–∏)
- ‚úÖ URL Parsing –∑–∞–¥–∞—á–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –°–í–û–ò –¥–∞–Ω–Ω—ã–µ (–∏–∑ `parsing_tasks.final_results`)
- ‚úÖ –ü—É—Å—Ç—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
- ‚úÖ –§–ª–∞–≥ `taskFound` —Ä–∞–∑–ª–∏—á–∞–µ—Ç "–∑–∞–¥–∞—á–∞ –Ω–∞–π–¥–µ–Ω–∞ –Ω–æ –ø—É—Å—Ç–∞" –æ—Ç "–∑–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
- ‚úÖ –ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –º–µ–∂–¥—É –∑–∞–¥–∞—á–∞–º–∏ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ `task_name`

---

## üîó –°–≤—è–∑—å —Å –¥—Ä—É–≥–∏–º–∏ fixes

### –°–≤—è–∑—å —Å LEGACY_DATA_MIGRATION_FIX.md:
- **–¢–æ—Ç fix**: –î–æ–±–∞–≤–∏–ª fallback –Ω–∞ `parsing_results` –¥–ª—è legacy –¥–∞–Ω–Ω—ã—Ö
- **–≠—Ç–æ—Ç fix**: –ò—Å–ø—Ä–∞–≤–∏–ª —É—Å–ª–æ–≤–∏–µ fallback —á—Ç–æ–±—ã –ù–ï —Å—Ä–∞–±–∞—Ç—ã–≤–∞–ª –¥–ª—è –ø—É—Å—Ç—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### –°–≤—è–∑—å —Å HISTORY_TASK_TYPE_FIX.md:
- **–¢–æ—Ç fix**: –î–æ–±–∞–≤–∏–ª –∫–æ–ª–æ–Ω–∫—É "–¢–∏–ø –ø–∞—Ä—Å–∏–Ω–≥–∞" –¥–ª—è —Ä–∞–∑–ª–∏—á–∏—è AI Search –∏ URL Parsing
- **–≠—Ç–æ—Ç fix**: –û–±–µ—Å–ø–µ—á–∏–ª —á—Ç–æ –∫–∞–∂–¥—ã–π —Ç–∏–ø –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –°–í–û–ò –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ üëÅ

### –°–≤—è–∑—å —Å PERSISTENT_TASK_TRACKING.md:
- **–¢–æ—Ç fix**: –í–Ω–µ–¥—Ä–∏–ª —Å–∏—Å—Ç–µ–º—É `parsing_tasks` —Å `final_results` JSONB –ø–æ–ª–µ–º
- **–≠—Ç–æ—Ç fix**: –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—É—Å—Ç–æ–≥–æ `final_results` –º–∞—Å—Å–∏–≤–∞

**–û–±—â–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω**: Fallback –º–µ—Ö–∞–Ω–∏–∑–º—ã —Ç—Ä–µ–±—É—é—Ç —Ç–æ—á–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –¥–∞–Ω–Ω—ã—Ö.

---

## üí° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 1. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

–î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `viewTaskResults()`:
```javascript
console.log('üëÅ viewTaskResults called:', {
    taskName,
    taskId,
    taskFound,
    resultsCount: results.length,
    source: taskId ? 'parsing_tasks' : 'parsing_results'
});
```

### 2. –í–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö

–ü—Ä–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ legacy —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∫–∞–∑–∞—Ç—å badge:
```javascript
if (!taskId && results.length > 0) {
    // –î–æ–±–∞–≤–∏—Ç—å –≤ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    modal.innerHTML = `
        <div class="legacy-badge">üìú Legacy –¥–∞–Ω–Ω—ã–µ</div>
        ${resultsTable}
    `;
}
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ task_type –ø–µ—Ä–µ–¥ fallback (–Ω–∞ –±—É–¥—É—â–µ–µ)

–î–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å `task_type`:
```javascript
if (!taskId) {
    const { data: legacyResults } = await this.supabase
        .from('parsing_results')
        .select('*')
        .eq('task_name', taskName)
        .eq('user_id', this.currentUser?.id);

    // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∏–ø–∞
    if (legacyResults && legacyResults[0]?.task_type === 'ai-search') {
        // –ë–µ–∑–æ–ø–∞—Å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å
    }
}
```

---

## üéØ Summary

**–ü—Ä–æ–±–ª–µ–º–∞**: URL Parsing –∑–∞–¥–∞—á–∏ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏ AI Search –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ üëÅ.

**Root Cause**: –£—Å–ª–æ–≤–∏–µ `if (!taskId || results.length === 0)` –≤—ã–∑—ã–≤–∞–ª–æ fallback –Ω–∞ `parsing_results` –¥–∞–∂–µ –∫–æ–≥–¥–∞ –∑–∞–¥–∞—á–∞ –±—ã–ª–∞ –Ω–∞–π–¥–µ–Ω–∞ –≤ `parsing_tasks` –Ω–æ –∏–º–µ–ª–∞ –ø—É—Å—Ç–æ–π `final_results` –º–∞—Å—Å–∏–≤.

**–†–µ—à–µ–Ω–∏–µ**:
1. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —Ñ–ª–∞–≥ `taskFound` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –Ω–∞–π–¥–µ–Ω–∞ –ª–∏ –∑–∞–¥–∞—á–∞ –≤ `parsing_tasks`
2. ‚úÖ –£–±—Ä–∞–Ω–æ —É—Å–ª–æ–≤–∏–µ `results.length === 0` –∏–∑ fallback –ª–æ–≥–∏–∫–∏
3. ‚úÖ Fallback –Ω–∞ `parsing_results` –¢–û–õ–¨–ö–û –∫–æ–≥–¥–∞ `taskId === null` (legacy –∑–∞–¥–∞—á–∏)
4. ‚úÖ –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö: "–±–µ–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤" vs "–Ω–µ –Ω–∞–π–¥–µ–Ω–∞"

**–†–µ–∑—É–ª—å—Ç–∞—Ç**:
- ‚úÖ URL Parsing –∑–∞–¥–∞—á–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –°–í–û–ò –¥–∞–Ω–Ω—ã–µ (–∏–∑ `parsing_tasks`)
- ‚úÖ –ü—É—Å—Ç—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–µ —Ç—Ä–∏–≥–≥–µ—Ä—è—Ç fallback
- ‚úÖ Legacy AI Search –∑–∞–¥–∞—á–∏ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —á–µ—Ä–µ–∑ `parsing_results`
- ‚úÖ –ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –º–µ–∂–¥—É –∑–∞–¥–∞—á–∞–º–∏ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ –∏–º–µ–Ω–∞–º–∏

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: 2025-10-01
**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
**–ö–æ–º–º–∏—Ç**: –ì–æ—Ç–æ–≤ –∫ push

**–°–æ–∑–¥–∞–Ω–æ —Å –ø–æ–º–æ—â—å—é Claude Code** | **GitHub**: https://github.com/gymnastika/parsing_project
