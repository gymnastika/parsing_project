<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google OAuth Callback - GYMNASTIKA</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #7C3AED 0%, #8B5CF6 100%);
            color: white;
        }
        .callback-container {
            text-align: center;
            padding: 2rem;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="callback-container">
        <div class="spinner"></div>
        <h2>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Google –∞–∫–∫–∞—É–Ω—Ç–∞...</h2>
        <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</p>
    </div>

    <script>
        console.log('üîÑ Google OAuth Callback page loaded at:', new Date().toISOString());
        console.log('üåê Full URL:', window.location.href);
        console.log('üîó Origin:', window.location.origin);
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º
        function updateUI(message, isError = false) {
            const container = document.querySelector('.callback-container');
            const spinner = container.querySelector('.spinner');
            const title = container.querySelector('h2');
            const text = container.querySelector('p');
            
            if (isError) {
                spinner.style.display = 'none';
                title.textContent = '–û—à–∏–±–∫–∞';
                title.style.color = '#ff6b6b';
                text.textContent = message;
            } else {
                title.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
                text.textContent = message;
            }
            
            console.log(`üì∫ UI Updated: ${message}`);
        }
        
        async function processCallback() {
            updateUI('–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–∑ URL...');
            
            // –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');
            const error_description = urlParams.get('error_description');
            
            console.log('üìù Raw URL parameters:');
            console.log('  - code:', code ? `${code.substring(0, 20)}...` : 'MISSING');
            console.log('  - state:', state ? `${state.substring(0, 20)}...` : 'MISSING');
            console.log('  - error:', error || 'none');
            console.log('  - error_description:', error_description || 'none');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∫–Ω–∞
            console.log('ü™ü Window state analysis:');
            console.log('  - window.opener exists:', !!window.opener);
            console.log('  - window.opener.closed:', window.opener ? window.opener.closed : 'N/A');
            console.log('  - window.parent !== window:', window.parent !== window);
            console.log('  - window.top !== window:', window.top !== window);
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∞ OAuth, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –µ—ë
            if (error) {
                updateUI(`–û—à–∏–±–∫–∞ OAuth: ${error_description || error}`, true);
                
                const errorData = {
                    type: 'google_oauth_callback',
                    error: error,
                    error_description: error_description,
                    timestamp: new Date().toISOString()
                };
                
                console.log('‚ùå OAuth error detected, sending error data:', errorData);
                
                if (window.opener && !window.opener.closed) {
                    console.log('üì§ Sending error to parent via opener');
                    window.opener.postMessage(errorData, window.location.origin);
                    setTimeout(() => window.close(), 3000);
                } else {
                    console.log('üîí No opener available for error, closing window');
                    setTimeout(() => window.close(), 3000);
                }
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–æ–¥–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            if (!code) {
                updateUI('–ö–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω', true);
                console.error('‚ùå No authorization code found in URL');
                setTimeout(() => window.close(), 3000);
                return;
            }
            
            if (!state) {
                updateUI('–ü–∞—Ä–∞–º–µ—Ç—Ä state –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç', true);
                console.error('‚ùå No state parameter found in URL');
                setTimeout(() => window.close(), 3000);
                return;
            }

            updateUI('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏...');

            // –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            const callbackData = {
                type: 'google_oauth_callback',
                code: code,
                state: state,
                error: null,
                error_description: null,
                timestamp: new Date().toISOString()
            };
            
            console.log('üì¶ Prepared callback data:', {
                type: callbackData.type,
                code: code ? 'present' : 'missing',
                state: state ? 'present' : 'missing',
                timestamp: callbackData.timestamp
            });

            updateUI('–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º—É –æ–∫–Ω—É...');

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ —Å —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–º –æ–∫–Ω–æ–º
            let messageSent = false;
            let sendAttempts = [];
            
            // –°–ø–æ—Å–æ–± 1: —á–µ—Ä–µ–∑ window.opener (popup)
            if (window.opener && !window.opener.closed) {
                console.log('üì§ Attempting to send callback data to parent window via opener');
                updateUI('–°–≤—è–∑—å —Å —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–º –æ–∫–Ω–æ–º —á–µ—Ä–µ–∑ opener...');
                
                try {
                    // –ü–æ–ø—Ä–æ–±—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
                    for (let i = 0; i < 3; i++) {
                        console.log(`üì§ Send attempt ${i + 1}/3 via opener`);
                        window.opener.postMessage(callbackData, window.location.origin);
                        await new Promise(resolve => setTimeout(resolve, 100)); // –ñ–¥–µ–º 100ms –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏
                    }
                    
                    messageSent = true;
                    sendAttempts.push('opener: success');
                    console.log('‚úÖ Message sent successfully via opener');
                    updateUI('–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ! –ó–∞–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞...');
                    
                    // –ñ–¥–µ–º –¥–æ–ª—å—à–µ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º —á—Ç–æ–±—ã –¥–∞—Ç—å –≤—Ä–µ–º—è –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É
                    setTimeout(() => {
                        console.log('üîí Closing popup window after successful send');
                        window.close();
                    }, 2000);
                    
                } catch (err) {
                    console.warn('‚ö†Ô∏è Failed to send message via opener:', err);
                    sendAttempts.push(`opener: failed - ${err.message}`);
                }
            } else {
                console.log('‚ùå window.opener not available or closed');
                sendAttempts.push('opener: not available');
            }
            
            // –°–ø–æ—Å–æ–± 2: —á–µ—Ä–µ–∑ window.parent (iframe)
            if (!messageSent && window.parent !== window) {
                console.log('üì§ Attempting to send callback data to parent frame');
                updateUI('–°–≤—è–∑—å —Å —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–º –æ–∫–Ω–æ–º —á–µ—Ä–µ–∑ parent...');
                
                try {
                    window.parent.postMessage(callbackData, window.location.origin);
                    messageSent = true;
                    sendAttempts.push('parent: success');
                    console.log('‚úÖ Message sent successfully via parent');
                    updateUI('–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ parent!');
                } catch (err) {
                    console.warn('‚ö†Ô∏è Failed to send message via parent:', err);
                    sendAttempts.push(`parent: failed - ${err.message}`);
                }
            } else if (window.parent === window) {
                sendAttempts.push('parent: same as window');
            }
            
            // –°–ø–æ—Å–æ–± 3: —á–µ—Ä–µ–∑ window.top
            if (!messageSent && window.top !== window) {
                console.log('üì§ Attempting to send callback data to top window');
                updateUI('–°–≤—è–∑—å —Å —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–º –æ–∫–Ω–æ–º —á–µ—Ä–µ–∑ top...');
                
                try {
                    window.top.postMessage(callbackData, window.location.origin);
                    messageSent = true;
                    sendAttempts.push('top: success');
                    console.log('‚úÖ Message sent successfully via top');
                    updateUI('–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ top!');
                } catch (err) {
                    console.warn('‚ö†Ô∏è Failed to send message via top:', err);
                    sendAttempts.push(`top: failed - ${err.message}`);
                }
            } else if (window.top === window) {
                sendAttempts.push('top: same as window');
            }
            
            console.log('üìä Send attempts summary:', sendAttempts);
            
            // –°–ø–æ—Å–æ–± 4: –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ, –ø—Ä–æ–±—É–µ–º localStorage
            if (!messageSent) {
                console.log('üè™ No direct messaging worked, trying localStorage backup');
                updateUI('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ localStorage...');
                
                try {
                    const backupData = {
                        ...callbackData,
                        backup: true,
                        savedAt: Date.now()
                    };
                    
                    localStorage.setItem('google_oauth_callback_backup', JSON.stringify(backupData));
                    console.log('‚úÖ Callback data saved to localStorage as backup');
                    sendAttempts.push('localStorage: saved');
                    updateUI('–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è');
                } catch (err) {
                    console.error('‚ùå Failed to save to localStorage:', err);
                    sendAttempts.push(`localStorage: failed - ${err.message}`);
                }
            }
            
            // –§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
            if (!messageSent) {
                updateUI('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≤—è–∑–∞—Ç—å—Å—è —Å —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–º –æ–∫–Ω–æ–º', true);
                console.error('‚ùå Failed to send message through any method:', sendAttempts);
                
                // –ñ–¥–µ–º –¥–æ–ª—å—à–µ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º –≤ —Å–ª—É—á–∞–µ –Ω–µ—É–¥–∞—á–∏
                setTimeout(() => {
                    console.log('üîí Closing window after failed attempts');
                    window.close();
                }, 5000);
            }
        }
        
        // –í—ã–∑—ã–≤–∞–µ–º async —Ñ—É–Ω–∫—Ü–∏—é —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
        processCallback().catch(err => {
            console.error('‚ùå Error in OAuth callback:', err);
            updateUI('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ callback', true);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—à–∏–±–∫—É –≤ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–µ –æ–∫–Ω–æ
            const errorData = {
                type: 'google_oauth_callback',
                error: 'callback_error',
                error_description: err.message,
                timestamp: new Date().toISOString(),
                stack: err.stack
            };
            
            console.log('üì§ Sending error data:', errorData);
            
            if (window.opener && !window.opener.closed) {
                try {
                    window.opener.postMessage(errorData, window.location.origin);
                    console.log('‚úÖ Error data sent via opener');
                } catch (sendErr) {
                    console.error('‚ùå Failed to send error via opener:', sendErr);
                }
                setTimeout(() => window.close(), 3000);
            } else if (window.parent !== window) {
                try {
                    window.parent.postMessage(errorData, window.location.origin);
                    console.log('‚úÖ Error data sent via parent');
                } catch (sendErr) {
                    console.error('‚ùå Failed to send error via parent:', sendErr);
                }
            } else {
                console.log('üîÑ Redirecting to main page with error');
                // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å –æ—à–∏–±–∫–æ–π
                window.location.href = `/?error=oauth_callback_error&message=${encodeURIComponent(err.message)}`;
            }
        });
    </script>
</body>
</html>